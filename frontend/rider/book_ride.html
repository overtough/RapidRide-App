<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Book a Ride ‚Äî RapidRide</title>
  <link rel="stylesheet" href="../common/css/global.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* Booking Split Layout */
    .booking-layout {
      display: grid;
      grid-template-columns: 400px 1fr;
      min-height: calc(100vh - 80px);
      /* Minus header */
    }

    @media (max-width: 900px) {
      .booking-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        height: auto;
      }
    }

    /* Left Panel: Controls */
    .booking-controls {
      background: var(--bg-sand);
      padding: 2rem;
      border-right: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      z-index: 10;
    }

    /* Right Panel: Map */
    .booking-map {
      width: 100%;
      height: 100%;
      min-height: 400px;
      background: #e5e5e5;
    }

    #map {
      width: 100%;
      height: 100%;
      min-height: 400px;
    }

    /* Input Dots */
    .location-input-group {
      position: relative;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .connector-line {
      position: absolute;
      left: 19px;
      top: 40px;
      bottom: -20px;
      width: 2px;
      background: #e5e5e5;
      z-index: 0;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
      z-index: 1;
    }

    .dot-pickup {
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .dot-drop {
      background: #ef4444;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
    }

    /* Vehicle Grid */
    .vehicle-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .vehicle-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem;
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      background: white;
      cursor: pointer;
      transition: 0.2s;
    }

    .vehicle-option:hover {
      border-color: var(--primary);
      transform: scale(1.01);
      box-shadow: var(--glass-shadow);
    }

    .vehicle-option.selected {
      border-color: var(--primary);
      background: #1c191708;
      /* Very subtle dark tint */
      box-shadow: 0 0 0 2px var(--primary);
    }

    .vehicle-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .vehicle-emoji {
      font-size: 2rem;
    }

    .price-tag {
      font-weight: 700;
      font-size: 1.1rem;
    }

    /* Hide routing directions panel */
    .leaflet-routing-container {
      display: none !important;
    }
  </style>
  <script src="../common/js/config.js"></script>
</head>

<body>

  <!-- Navbar (Consistent) -->
  <nav class="navbar">
    <div style="display: flex; align-items: center; gap: 1rem; cursor: pointer;"
      onclick="window.location.href='rider_home.html'">
      <div class="btn-secondary"
        style="width: 40px; height: 40px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e5e5;">
        ‚Üê
      </div>
      <span style="font-weight: 800; font-size: 1.1rem;">Plan your ride</span>
    </div>

    <!-- Optional: Profile or Help -->
    <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-secondary);">Help</div>
  </nav>

  <div class="booking-layout">

    <!-- Controls Panel -->
    <div class="booking-controls fade-in">

      <!-- Route Inputs -->
      <div class="glass-card" style="padding: 1.5rem; background: white; border: 1px solid var(--glass-border);">
        <div class="location-input-group" style="margin-bottom: 1.5rem;">
          <div class="dot dot-pickup"></div>
          <div style="flex:1;">
            <label style="font-size: 0.85rem; margin-bottom: 0.25rem;">Pickup Location</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="text" id="pickupInput" class="input-field" placeholder="Search pickup..." style="flex: 1;">
              <button id="currentLocationBtn"
                style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; padding: 12px 16px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);">
                <span style="font-size: 1.1rem;">üìç</span>
                <span>Current</span>
              </button>
            </div>
          </div>
          <div class="connector-line"></div>
        </div>

        <div class="location-input-group">
          <div class="dot dot-drop"></div>
          <div style="flex:1;">
            <label style="font-size: 0.85rem; margin-bottom: 0.25rem;">Drop Location</label>
            <input type="text" id="dropInput" class="input-field" placeholder="Where to?">
          </div>
        </div>
      </div>

      <!-- Vehicle Selection (Hidden initially) -->
      <div id="vehicleSection" style="display: none;" class="slide-up">
        <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">Select Ride</h3>
        <div class="vehicle-grid" id="vehicleGrid">
          <!-- JS Injected Params -->
        </div>
      </div>

      <!-- Action Button -->
      <div style="margin-top: auto;">
        <button id="bookRideBtn" class="btn btn-primary w-full" disabled onclick="requestRide()">
          Confirm Booking
        </button>
      </div>

    </div>

    <!-- Map Panel -->
    <div class="booking-map">
      <div id="map"></div>
    </div>

  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <!-- Location Autocomplete (Re-using existing logic) -->
  <script src="../common/js/location-autocomplete.js"></script>
  <script src="../common/js/config.js"></script>

  <script>
    // Initialize Map
    const map = L.map('map', { zoomControl: false }).setView([17.3850, 78.4867], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    // Store locations and map elements
    let pickupLocation = null;
    let dropLocation = null;
    let fareEstimates = {};
    let pickupMarker = null;
    let dropMarker = null;
    let routingControl = null;

    // Update map with markers and route
    function updateMap() {
      // Clear existing markers
      if (pickupMarker) map.removeLayer(pickupMarker);
      if (dropMarker) map.removeLayer(dropMarker);
      if (routingControl) map.removeControl(routingControl);

      // Add pickup marker
      if (pickupLocation) {
        const pickupIcon = L.divIcon({
          html: '<div style="background: #10b981; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üìç</div>',
          className: '',
          iconSize: [32, 32]
        });
        pickupMarker = L.marker([pickupLocation.lat, pickupLocation.lng], { icon: pickupIcon })
          .addTo(map)
          .bindPopup(`<b>Pickup:</b><br>${pickupLocation.address}`);
      }

      // Add drop marker
      if (dropLocation) {
        const dropIcon = L.divIcon({
          html: '<div style="background: #ef4444; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üéØ</div>',
          className: '',
          iconSize: [32, 32]
        });
        dropMarker = L.marker([dropLocation.lat, dropLocation.lng], { icon: dropIcon })
          .addTo(map)
          .bindPopup(`<b>Drop:</b><br>${dropLocation.address}`);
      }

      // Draw route if both locations are set
      if (pickupLocation && dropLocation) {
        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(pickupLocation.lat, pickupLocation.lng),
            L.latLng(dropLocation.lat, dropLocation.lng)
          ],
          routeWhileDragging: false,
          show: false,
          addWaypoints: false,
          lineOptions: {
            styles: [{
              color: '#6366f1',
              opacity: 0.8,
              weight: 6
            }]
          },
          createMarker: function () { return null; } // Don't create default markers
        }).addTo(map);

        // Hide the directions panel
        setTimeout(() => {
          const routingContainer = document.querySelector('.leaflet-routing-container');
          if (routingContainer) routingContainer.style.display = 'none';
        }, 100);

        // Calculate midpoint and center at zoom 17
        const midLat = (pickupLocation.lat + dropLocation.lat) / 2;
        const midLng = (pickupLocation.lng + dropLocation.lng) / 2;
        map.setView([midLat, midLng], 17);
      } else if (pickupLocation) {
        // Only pickup set, center at zoom 17
        map.setView([pickupLocation.lat, pickupLocation.lng], 17);
      } else if (dropLocation) {
        // Only drop set, center at zoom 17
        map.setView([dropLocation.lat, dropLocation.lng], 17);
      }
    }

    const VEHICLES = [
      { type: 'bike', name: 'Rapid Bike', icon: 'üèçÔ∏è' },
      { type: 'auto', name: 'Auto', icon: 'üõ∫' },
      { type: 'car', name: 'Mini Cab', icon: 'üöó' },
      { type: 'suv', name: 'Prime SUV', icon: 'üöô' },
    ];

    // Call backend API for fare estimate
    async function getFareEstimate(pickup, destination) {
      try {
        const firebaseToken = localStorage.getItem('firebaseToken');
        if (!firebaseToken) {
          console.error('No authentication token');
          return null;
        }

        const response = await fetch(`${API_CONFIG.BASE_URL}/rides/estimate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${firebaseToken}`
          },
          body: JSON.stringify({
            pickup: { lat: pickup.lat, lng: pickup.lng },
            destination: { lat: destination.lat, lng: destination.lng }
          })
        });

        const data = await response.json();
        if (data.fare !== undefined) {
          return {
            distance: data.distance_km,
            fare: data.fare,
            eta_minutes: data.eta_minutes,
            currency: data.currency || 'INR'
          };
        }
        return null;
      } catch (error) {
        console.error('Fare estimate error:', error);
        return null;
      }
    }

    // Show vehicles with REAL backend estimates
    async function showVehicles(distance) {
      const grid = document.getElementById('vehicleGrid');
      document.getElementById('vehicleSection').style.display = 'block';

      if (!pickupLocation || !dropLocation) {
        console.error('Locations not set');
        return;
      }

      // Get fare estimate from backend
      const estimate = await getFareEstimate(pickupLocation, dropLocation);

      if (!estimate) {
        console.warn('Could not get fare estimate, using fallback');
        // Fallback to static calculation
        grid.innerHTML = VEHICLES.map(v => {
          const price = Math.round(50 + (distance * 12)); // Fallback
          return `
            <div class="vehicle-option" onclick="selectVehicle(this, '${v.type}', ${price})">
                <div class="vehicle-left">
                    <span class="vehicle-emoji">${v.icon}</span>
                    <div>
                        <div style="font-weight: 700;">${v.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">~${estimate?.eta_minutes || 5} mins away</div>
                    </div>
                </div>
                <div class="price-tag">‚Çπ${price}</div>
            </div>
          `;
        }).join('');
        return;
      }

      // Use backend estimates
      fareEstimates = estimate;

      grid.innerHTML = VEHICLES.map(v => {
        // Backend returns base fare, adjust for vehicle type
        const multipliers = { bike: 0.7, auto: 1.0, car: 1.4, suv: 2.0 };
        const price = Math.round(estimate.fare * (multipliers[v.type] || 1.0));

        return `
          <div class="vehicle-option" onclick="selectVehicle(this, '${v.type}', ${price})">
              <div class="vehicle-left">
                  <span class="vehicle-emoji">${v.icon}</span>
                  <div>
                      <div style="font-weight: 700;">${v.name}</div>
                      <div style="font-size: 0.8rem; color: var(--text-muted);">${estimate.distance.toFixed(1)} km ‚Ä¢ ${estimate.eta_minutes} mins</div>
                  </div>
              </div>
              <div class="price-tag">‚Çπ${price}</div>
          </div>
        `;
      }).join('');
    }

    function selectVehicle(el, type, price) {
      document.querySelectorAll('.vehicle-option').forEach(d => d.classList.remove('selected'));
      el.classList.add('selected');

      const btn = document.getElementById('bookRideBtn');
      btn.disabled = false;
      btn.innerHTML = `Book ${type.toUpperCase()} - ‚Çπ${price}`;
      btn.dataset.vehicleType = type;
      btn.dataset.fare = price;
    }

    // Request ride function
    async function requestRide() {
      const btn = document.getElementById('bookRideBtn');
      const vehicleType = btn.dataset.vehicleType;
      const fare = btn.dataset.fare;

      if (!vehicleType || !pickupLocation || !dropLocation) {
        alert('Please select pickup, drop, and vehicle type');
        return;
      }

      try {
        btn.disabled = true;
        btn.textContent = 'Requesting...';

        const firebaseToken = localStorage.getItem('firebaseToken');
        const response = await fetch(`${API_CONFIG.BASE_URL}/rides/request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${firebaseToken}`
          },
          body: JSON.stringify({
            pickup: {
              address: pickupLocation.address || `${pickupLocation.lat}, ${pickupLocation.lng}`,
              lat: pickupLocation.lat,
              lng: pickupLocation.lng
            },
            destination: {
              address: dropLocation.address || `${dropLocation.lat}, ${dropLocation.lng}`,
              lat: dropLocation.lat,
              lng: dropLocation.lng
            },
            vehicleType: vehicleType,
            payment_method: 'cash'
          })
        });

        const data = await response.json();

        if (data.success) {
          // Redirect to ride status page
          window.location.href = `ride_status.html?rideId=${data.rideId}`;
        } else {
          alert('Failed to request ride: ' + (data.message || 'Unknown error'));
          btn.disabled = false;
          btn.textContent = 'Try Again';
        }
      } catch (error) {
        console.error('Request error:', error);
        alert('Network error. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Try Again';
      }
    }

    // Current Location Button Handler
    document.getElementById('currentLocationBtn').addEventListener('click', async function () {
      const btn = this;
      const originalContent = btn.innerHTML;

      try {
        btn.innerHTML = '<span style="font-size: 1.1rem;">‚è≥</span><span>Getting...</span>';
        btn.disabled = true;
        btn.style.opacity = '0.7';

        // Get current position
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          });
        });

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        console.log('üìç Current location:', lat, lng);

        // Reverse geocode to get address
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`,
            { headers: { 'User-Agent': 'RapidRide/1.0' } }
          );
          const data = await response.json();

          const addressName = data.address?.road || data.address?.neighbourhood ||
            data.address?.suburb || data.display_name.split(',')[0] || 'Current Location';

          // Set pickup location
          pickupLocation = {
            lat: lat,
            lng: lng,
            address: addressName
          };

          // Update input
          document.getElementById('pickupInput').value = addressName;

          console.log('‚úÖ Current location set:', addressName);

          // Update map
          updateMap();

          // If drop is also set, fetch estimate
          if (dropLocation) {
            showVehicles(0);
          }

          // Success feedback
          btn.innerHTML = '<span style="font-size: 1.1rem;">‚úÖ</span><span>Got it!</span>';
          setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
            btn.style.opacity = '1';
          }, 2000);

        } catch (geocodeError) {
          console.warn('Reverse geocoding failed, using coordinates');

          // Fallback: use coordinates as address
          pickupLocation = {
            lat: lat,
            lng: lng,
            address: `${lat.toFixed(5)}, ${lng.toFixed(5)}`
          };
          document.getElementById('pickupInput').value = pickupLocation.address;

          btn.innerHTML = '<span style="font-size: 1.1rem;">‚úÖ</span><span>Located!</span>';
          setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
            btn.style.opacity = '1';
          }, 2000);
        }

      } catch (error) {
        console.error('Geolocation error:', error);

        let errorMsg = 'Failed';
        if (error.code === 1) {
          errorMsg = 'Permission denied';
          alert('Please allow location access to use this feature.');
        } else if (error.code === 2) {
          errorMsg = 'Not available';
        } else if (error.code === 3) {
          errorMsg = 'Timeout';
        }

        btn.innerHTML = `<span style="font-size: 1.1rem;">‚ùå</span><span>${errorMsg}</span>`;
        setTimeout(() => {
          btn.innerHTML = originalContent;
          btn.disabled = false;
          btn.style.opacity = '1';
        }, 2000);
      }
    });

    // Initialize location autocomplete
    console.log('üöÄ Initializing autocomplete...');

    initLocationAutocomplete('pickupInput', (location) => {
      console.log('‚úÖ Pickup selected:', location);
      pickupLocation = {
        lat: location.lat,
        lng: location.lon,
        address: location.name
      };

      // Update map
      updateMap();

      // If drop is also set, fetch estimate
      if (dropLocation) {
        showVehicles(0);
      }
    });

    initLocationAutocomplete('dropInput', (location) => {
      console.log('‚úÖ Drop selected:', location);
      dropLocation = {
        lat: location.lat,
        lng: location.lon,
        address: location.name
      };

      // Update map
      updateMap();

      // If pickup is also set, fetch estimate
      if (pickupLocation) {
        showVehicles(0);
      }
    });

    // Auto-zoom to current location on page load
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          console.log('üìç Auto-centering map to current location:', lat, lng);

          // Smoothly pan and zoom to user's location
          map.flyTo([lat, lng], 17, {
            duration: 1.5,
            easeLinearity: 0.5
          });
        },
        (error) => {
          console.log('‚ö†Ô∏è Could not get location for auto-zoom:', error.message);
          // Keep default location (already set)
        },
        {
          enableHighAccuracy: false, // Don't need high accuracy for initial view
          timeout: 5000,
          maximumAge: 300000 // Allow cached position
        }
      );
    }

    // Auto-focus pickup
    document.getElementById('pickupInput').focus();
  </script>
</body>

</html>