<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ride Status ‚Äî RapidRide</title>
  <link rel="stylesheet" href="../common/css/global.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      padding: 0;
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-border);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      color: var(--primary);
      transform: scale(1.1);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    /* Progress Bar Styles */
    .progress-section {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .progress-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .progress-header h2 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .progress-header p {
      color: var(--text-muted);
    }

    .progress-container {
      position: relative;
      margin: 3rem 0;
    }

    .progress-bar-track {
      position: relative;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #10b981);
      border-radius: 10px;
      transition: width 1s ease-in-out;
      position: relative;
      overflow: hidden;
    }

    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
      position: relative;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .step-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
      border: 3px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.75rem;
      font-size: 1.5rem;
      transition: all 0.5s ease;
      position: relative;
      z-index: 2;
    }

    .progress-step.active .step-icon {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-color: var(--primary);
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
    }

    .progress-step.completed .step-icon {
      background: linear-gradient(135deg, #22c55e, #10b981);
      border-color: #22c55e;
    }

    .step-label {
      font-size: 0.9rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .progress-step.active .step-label,
    .progress-step.completed .step-label {
      color: var(--text);
    }

    /* Cancel Request Button */
    .cancel-request-section {
      text-align: center;
      margin-top: 2rem;
    }

    .btn-cancel-request {
      padding: 1rem 2.5rem;
      background: rgba(239, 68, 68, 0.1);
      border: 2px solid #ef4444;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      color: #ef4444;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-cancel-request:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
    }

    /* Driver Details Section */
    .driver-section {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      display: none;
    }

    .driver-section.show {
      display: block;
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .driver-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .driver-header h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    .driver-info-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--glass-border);
      border-radius: 15px;
      padding: 1.5rem;
      display: flex;
      gap: 1.5rem;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .driver-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .driver-details {
      flex: 1;
    }

    .driver-name {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .driver-phone {
      color: var(--text-muted);
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }

    .vehicle-info {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .vehicle-badge {
      padding: 0.4rem 0.9rem;
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid var(--primary);
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .otp-card {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .otp-label {
      font-size: 1rem;
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }

    .otp-value {
      font-size: 3rem;
      font-weight: 700;
      letter-spacing: 0.8rem;
      font-family: 'Courier New', monospace;
    }

    /* Map Section */
    .map-section {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: none;
    }

    .map-section.show {
      display: block;
      animation: slideUp 0.5s ease;
    }

    .map-container {
      height: 400px;
      width: 100%;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .ride-locations {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .location-marker {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
    }

    .marker-icon {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .marker-icon.pickup {
      background: rgba(34, 197, 94, 0.2);
      border: 2px solid #22c55e;
    }

    .marker-icon.drop {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
    }

    .marker-text {
      flex: 1;
    }

    .marker-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .marker-address {
      font-weight: 600;
    }

    /* Ride Details Grid */
    .ride-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .ride-detail-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 1.25rem;
    }

    .ride-detail-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .ride-detail-value {
      font-size: 1.3rem;
      font-weight: 600;
    }

    /* Action Buttons */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .btn {
      padding: 1rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-call {
      background: rgba(34, 197, 94, 0.2);
      border: 2px solid #22c55e;
      color: #22c55e;
    }

    .btn-call:hover {
      background: rgba(34, 197, 94, 0.3);
      transform: translateY(-2px);
    }

    .btn-cancel {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
      color: #ef4444;
    }

    .btn-cancel:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: translateY(-2px);
    }

    /* Cancel Modal */
    .cancel-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .cancel-modal.show {
      display: flex;
    }

    .cancel-modal-content {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 2rem;
      max-width: 450px;
      width: 90%;
      text-align: center;
    }

    .cancel-modal-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .cancel-modal h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .cancel-modal p {
      color: var(--text-muted);
      margin-bottom: 2rem;
    }

    .cancel-modal-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .btn-confirm-cancel {
      padding: 1rem;
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      color: #ef4444;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-confirm-cancel:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .btn-keep-ride {
      padding: 1rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-keep-ride:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
    }

    /* Toast Message */
    .toast-message {
      position: fixed;
      top: 100px;
      right: 20px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      min-width: 300px;
      max-width: 400px;
      z-index: 10001;
      display: none;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: slideInRight 0.3s ease;
    }

    .toast-message.show {
      display: flex;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast-icon {
      font-size: 1.8rem;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 1rem;
    }

    .toast-text {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .toast-close {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2rem;
      color: var(--text-muted);
    }

    .toast-close:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }

    .toast-message.success {
      border-left: 4px solid #22c55e;
    }

    .toast-message.error {
      border-left: 4px solid #ef4444;
    }

    .toast-message.info {
      border-left: 4px solid var(--primary);
    }

    /* Rating Modal */
    .rating-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .rating-modal-overlay.active {
      display: flex;
    }

    .rating-modal {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.95));
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 2.5rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .rating-modal-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .rating-modal-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .rating-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .rating-modal-subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .driver-info-rating {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      margin-bottom: 2rem;
    }

    .driver-avatar-rating {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    .driver-details-rating {
      flex: 1;
    }

    .driver-name-rating {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .driver-vehicle-rating {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .stars-container {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 2rem 0;
    }

    .star {
      font-size: 2.5rem;
      color: #64748b;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .star:hover,
    .star.active {
      color: #fbbf24;
      transform: scale(1.2);
    }

    .feedback-container {
      margin-bottom: 2rem;
    }

    .feedback-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .feedback-textarea {
      width: 100%;
      min-height: 100px;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.9rem;
      resize: vertical;
      transition: all 0.3s ease;
    }

    .feedback-textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.08);
    }

    .feedback-textarea::placeholder {
      color: var(--text-muted);
    }

    .rating-modal-actions {
      display: flex;
      gap: 1rem;
    }

    .btn-rating {
      flex: 1;
      padding: 1rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-rating-skip {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      color: var(--text);
    }

    .btn-rating-skip:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .btn-rating-submit {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .btn-rating-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
    }

    .btn-rating-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    @media (max-width: 768px) {
      .progress-steps {
        flex-direction: column;
        gap: 1.5rem;
      }

      .progress-step {
        display: flex;
        align-items: center;
        gap: 1rem;
        text-align: left;
      }

      .step-icon {
        margin: 0;
      }

      .action-buttons {
        grid-template-columns: 1fr;
      }

      .rating-modal {
        padding: 1.5rem;
      }

      .stars-container {
        gap: 0.5rem;
      }

      .star {
        font-size: 2rem;
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
  <script src="../../../../../../../common/js/config.js"></script>
</head>

<body>
  <header class="topbar">
    <div class="topbar-left">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <strong>Ride Status</strong>
    </div>
  </header>

  <!-- Loading State -->
  <div id="loadingState"
    style="display: flex; justify-content: center; align-items: center; min-height: 60vh; flex-direction: column; gap: 1rem;">
    <div
      style="width: 50px; height: 50px; border: 4px solid rgba(139, 92, 246, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;">
    </div>
    <p style="color: var(--text-muted);">Loading ride information...</p>
  </div>

  <div class="container" style="display: none;">
    <!-- Progress Section -->
    <div class="progress-section">
      <div class="progress-header">
        <h2>Finding Your Driver</h2>
        <p id="progressSubtext">Please wait while we connect you with a nearby driver</p>
      </div>

      <div class="progress-container">
        <div class="progress-bar-track">
          <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;"></div>
        </div>

        <div class="progress-steps">
          <div class="progress-step" id="step1">
            <div class="step-icon">üìç</div>
            <div class="step-label">Ride Booked</div>
          </div>
          <div class="progress-step" id="step2">
            <div class="step-icon">üì¢</div>
            <div class="step-label">Drivers Alerted</div>
          </div>
          <div class="progress-step" id="step3">
            <div class="step-icon">‚úÖ</div>
            <div class="step-label">Booking Confirmed</div>
          </div>
        </div>
      </div>

      <div class="cancel-request-section" id="cancelRequestSection">
        <button class="btn-cancel-request" onclick="showCancelModal()">
          ‚úñ Cancel Request
        </button>
      </div>
    </div>

    <!-- Driver Section (Hidden until ride accepted) -->
    <div class="driver-section" id="driverSection">
      <div class="driver-header">
        <h3>üéâ Driver Found!</h3>
        <p>Your driver is on the way</p>
      </div>

      <div class="driver-info-card">
        <div class="driver-avatar" id="driverAvatar">D</div>
        <div class="driver-details">
          <div class="driver-name" id="driverName">Loading...</div>
          <div class="driver-phone" id="driverPhone">üìû Loading...</div>
          <div class="vehicle-info" id="vehicleInfo">
            <div class="vehicle-badge">üöó Loading...</div>
          </div>
        </div>
      </div>

      <div class="otp-card" id="otpCard" style="display: none;">
        <div class="otp-label">Your Ride OTP</div>
        <div class="otp-value" id="otpValue">----</div>
        <div style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.9;">Share this OTP with your driver</div>
      </div>

      <div class="ride-details-grid">
        <div class="ride-detail-card">
          <div class="ride-detail-label">Fare Amount</div>
          <div class="ride-detail-value" id="fareAmount">‚Çπ--</div>
        </div>
        <div class="ride-detail-card">
          <div class="ride-detail-label">Distance</div>
          <div class="ride-detail-value" id="distanceValue">-- km</div>
        </div>
        <div class="ride-detail-card">
          <div class="ride-detail-label">Estimated Time</div>
          <div class="ride-detail-value" id="etaValue">-- min</div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-call" onclick="callDriver()">
          üìû Call Driver
        </button>
        <button class="btn btn-cancel" onclick="showCancelModal()">
          ‚úñ Cancel Ride
        </button>
      </div>
    </div>

    <!-- Map Section (Hidden until ride accepted) -->
    <div class="map-section" id="mapSection">
      <div class="ride-locations">
        <div class="location-marker">
          <div class="marker-icon pickup">üìç</div>
          <div class="marker-text">
            <div class="marker-label">Pickup Location</div>
            <div class="marker-address" id="pickupAddress">Loading...</div>
          </div>
        </div>
        <div class="location-marker">
          <div class="marker-icon drop">üéØ</div>
          <div class="marker-text">
            <div class="marker-label">Drop Location</div>
            <div class="marker-address" id="dropAddress">Loading...</div>
          </div>
        </div>
      </div>

      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <!-- Cancel Confirmation Modal -->
  <div class="cancel-modal" id="cancelModal">
    <div class="cancel-modal-content">
      <div class="cancel-modal-icon">‚ö†Ô∏è</div>
      <h3>Cancel Ride?</h3>
      <p>Are you sure you want to cancel this ride request?</p>
      <div class="cancel-modal-buttons">
        <button class="btn-confirm-cancel" onclick="confirmCancel()">
          Yes, Cancel
        </button>
        <button class="btn-keep-ride" onclick="hideCancelModal()">
          Keep Ride
        </button>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div class="rating-modal-overlay" id="ratingModalOverlay">
    <div class="rating-modal">
      <div class="rating-modal-header">
        <div class="rating-modal-icon">‚≠ê</div>
        <h2 class="rating-modal-title">Rate Your Ride</h2>
        <p class="rating-modal-subtitle">How was your experience?</p>
      </div>

      <div class="driver-info-rating" id="driverInfoRating">
        <div class="driver-avatar-rating" id="driverAvatarRating">D</div>
        <div class="driver-details-rating">
          <div class="driver-name-rating" id="driverNameRating">Driver Name</div>
          <div class="driver-vehicle-rating" id="driverVehicleRating">Vehicle Info</div>
        </div>
      </div>

      <div class="stars-container" id="starsContainer">
        <span class="star" data-rating="1">‚òÖ</span>
        <span class="star" data-rating="2">‚òÖ</span>
        <span class="star" data-rating="3">‚òÖ</span>
        <span class="star" data-rating="4">‚òÖ</span>
        <span class="star" data-rating="5">‚òÖ</span>
      </div>

      <div class="feedback-container">
        <label class="feedback-label" for="feedbackText">Additional Feedback (Optional)</label>
        <textarea id="feedbackText" class="feedback-textarea" placeholder="Share your experience..."
          maxlength="500"></textarea>
      </div>

      <div class="rating-modal-actions">
        <button class="btn-rating btn-rating-skip" onclick="skipRating()">Skip</button>
        <button class="btn-rating btn-rating-submit" id="btnSubmitRating" onclick="submitRating()" disabled>Submit
          Rating</button>
      </div>
    </div>
  </div>

  <!-- Toast Message -->
  <div class="toast-message" id="toastMessage">
    <div class="toast-icon" id="toastIcon">‚ÑπÔ∏è</div>
    <div class="toast-content">
      <div class="toast-title" id="toastTitle">Information</div>
      <div class="toast-text" id="toastText">Message</div>
    </div>
    <div class="toast-close" onclick="hideToast()">√ó</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="../common/js/firebase-config.js"></script>
  <script src="../common/js/config.js"></script>
  <script src="../common/js/routing.js"></script> <!-- Shared Routing Logic -->
  <script src="../common/js/auth.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map;
    let pickupMarker;
    let dropMarker;
    let driverMarker;
    let routeLine;
    let socket;
    let currentRide = null;
    let progressInterval = null;
    let currentProgress = 0;
    let hasActiveRide = false; // Track if there's an active ride
    const API_BASE = API_CONFIG.BASE_URL;

    // Get ride ID from URL or fetch current ride
    const urlParams = new URLSearchParams(window.location.search);
    const rideId = urlParams.get('rideId');

    // Initialize
    window.addEventListener('load', async () => {
      console.log('Page loaded, checking for rides...');

      // Wait for Firebase auth
      if (typeof firebase !== 'undefined' && firebase.auth) {
        try {
          await Promise.race([
            new Promise((resolve) => {
              const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                unsubscribe();
                if (!user) {
                  console.warn('No Firebase user - redirecting to sign in');
                  window.location.href = '../common/signin-phone.html';
                  return;
                }
                resolve(user);
              });
            }),
            new Promise((resolve) => setTimeout(() => resolve(null), 3000))
          ]);
        } catch (e) {
          console.error('Firebase auth check failed:', e);
        }
      }

      // Ensure loading state is visible
      const loadingState = document.getElementById('loadingState');
      const container = document.querySelector('.container');
      console.log('Initial state - Loading visible:', loadingState?.style.display, 'Container visible:', container?.style.display);

      await loadCurrentRide();

      console.log('After loadCurrentRide - hasActiveRide:', hasActiveRide);

      // Only initialize socket if there's an active ride
      if (hasActiveRide) {
        console.log('Initializing socket for active ride');
        initSocket();
      } else {
        console.log('No active ride, socket not initialized');
      }
    });

    async function loadCurrentRide() {
      try {
        let response;
        if (rideId) {
          // Fetch specific ride by ID
          response = await apiFetch(`/rides/${rideId}`);
        } else {
          // Fetch current active ride
          response = await apiFetch('/rides/current');
        }

        console.log('Response status:', response.status);

        if (response.status === 404) {
          // No active ride, show no ride state
          console.log('No active ride found (404)');
          hasActiveRide = false;
          showNoRideState();
          return;
        }

        if (!response.ok) {
          console.log('Response not ok:', response.status);
          console.error('Error response:', response.data);
          hasActiveRide = false;
          throw new Error(response.data?.message || 'Failed to fetch ride details');
        }

        currentRide = response.data;
        console.log('Current ride loaded:', currentRide);
        console.log('Ride status:', currentRide.status);
        console.log('Ride ID:', currentRide._id);
        console.log('Driver data:', currentRide.driver); // DEBUG: Check driver data
        console.log('Ride created at:', new Date(currentRide.createdAt || Date.now()).toLocaleString());

        // Check if ride exists and has valid status
        if (!currentRide || !currentRide.status) {
          console.log('Invalid ride data, showing no ride state');
          hasActiveRide = false;
          showNoRideState();
          return;
        }

        // If ride is completed or cancelled, show no ride state
        if (currentRide.status === 'completed' || currentRide.status === 'cancelled') {
          console.log('Ride is completed/cancelled, showing no ride state');
          hasActiveRide = false;
          showNoRideState();
          return;
        }

        // Valid active ride found
        hasActiveRide = true;
        displayRideStatus(currentRide);

      } catch (error) {
        console.error('Error loading ride:', error);
        hasActiveRide = false;
        showNoRideState();
      }
    }

    function showNoRideState() {
      console.log('Showing no ride state');

      // Hide loading state
      const loadingState = document.getElementById('loadingState');
      if (loadingState) {
        loadingState.style.display = 'none';
      }

      // Get container and clear everything
      const container = document.querySelector('.container');
      if (!container) {
        console.error('Container not found');
        return;
      }

      // Show container and replace content with no ride message
      container.style.display = 'block';
      container.innerHTML = `
        <div class="progress-section" style="display: block; text-align: center; padding: 4rem 2rem;">
          <div style="font-size: 5rem; margin-bottom: 1.5rem; opacity: 0.6;">üöó</div>
          <h2 style="font-size: 1.8rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">No Ongoing Ride</h2>
          <p style="color: var(--text-muted); margin-bottom: 2rem;">You don't have any active rides at the moment</p>
          <button onclick="window.location.href='book_ride.html'" style="padding: 1rem 2.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease;">
            Book a Ride
          </button>
        </div>
      `;

      console.log('No ride state displayed');
    }

    function displayRideStatus(ride) {
      console.log('Displaying ride status:', ride);

      // Hide loading state
      const loadingState = document.getElementById('loadingState');
      if (loadingState) {
        loadingState.style.display = 'none';
      }

      // Show the container since we have an active ride
      const container = document.querySelector('.container');
      if (container) {
        container.style.display = 'block';
      }

      // Display ride details
      document.getElementById('pickupAddress').textContent = ride.pickup?.address || 'Loading...';
      document.getElementById('dropAddress').textContent = ride.dropoff?.address || ride.destination?.address || 'Loading...';
      document.getElementById('fareAmount').textContent = '‚Çπ' + (ride.fare || '--');
      document.getElementById('distanceValue').textContent = ride.distance ? (ride.distance / 1000).toFixed(1) + ' km' : '-- km';
      document.getElementById('etaValue').textContent = ride.estimatedTime ? Math.round(ride.estimatedTime / 60) + ' min' : '-- min';

      // Handle different ride statuses
      console.log('Ride status:', ride.status);
      switch (ride.status) {
        case 'requested':
          console.log('Starting progress bar...');
          startProgressBar();
          break;
        case 'accepted':
          console.log('Ride accepted - completing progress bar...');
          completeProgressBar();
          updateStatusHeader('accepted');
          showDriverDetails(ride);
          initializeMap(ride);
          break;
        case 'arrived':
          console.log('Driver arrived - completing progress bar...');
          completeProgressBar();
          updateStatusHeader('arrived');
          showDriverDetails(ride);
          initializeMap(ride);
          break;
        case 'started':
          console.log('Ride started - completing progress bar...');
          completeProgressBar();
          updateStatusHeader('started');
          showDriverDetails(ride);
          initializeMap(ride);
          break;
        case 'completed':
          console.log('Ride already completed, redirecting immediately');
          window.location.href = 'rider_home.html';
          break;
        case 'cancelled':
          showToast('Ride Cancelled', 'This ride has been cancelled. Redirecting to book ride...', 'error');
          setTimeout(() => {
            window.location.href = 'book_ride.html';
          }, 2000);
          break;
        default:
          console.log('Unknown status, starting progress bar');
          startProgressBar();
      }
    }

    function updateStatusHeader(status) {
      const progressHeader = document.querySelector('.progress-header h2');
      const progressSubtext = document.getElementById('progressSubtext');

      if (!progressHeader || !progressSubtext) return;

      switch (status) {
        case 'accepted':
          progressHeader.textContent = 'üéâ Driver Found!';
          progressSubtext.textContent = 'Your driver is on the way to pickup';
          break;
        case 'arrived':
          progressHeader.textContent = 'üëã Driver at Pickup';
          progressSubtext.textContent = 'Your driver is waiting for you';
          break;
        case 'started':
          progressHeader.textContent = 'üöÄ Ride in Progress';
          progressSubtext.textContent = 'Your driver is taking you to your destination';
          break;
      }
    }

    function startProgressBar() {
      console.log('startProgressBar called');

      // Clear any existing interval
      if (progressInterval) {
        clearInterval(progressInterval);
      }

      // Step 1: Ride Booked (immediate)
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const progressBarFill = document.getElementById('progressBarFill');
      const progressSubtext = document.getElementById('progressSubtext');

      console.log('Elements found:', { step1, step2, progressBarFill, progressSubtext });

      step1.classList.add('completed');
      currentProgress = 35;
      progressBarFill.style.width = currentProgress + '%';
      console.log('Progress set to 35%');

      // Step 2: Drivers Alerted (after 1 second)
      setTimeout(() => {
        step2.classList.add('active');
        currentProgress = 70;
        progressBarFill.style.width = currentProgress + '%';
        progressSubtext.textContent = 'Notifying nearby drivers...';
        console.log('Progress set to 70%');
      }, 1000);

      // Simulate progress while waiting for driver acceptance
      progressInterval = setInterval(() => {
        if (currentProgress < 95) {
          currentProgress += 0.5;
          progressBarFill.style.width = currentProgress + '%';
        }
      }, 500);

      console.log('Progress interval started');
    }

    function completeProgressBar() {
      // Stop simulation
      if (progressInterval) {
        clearInterval(progressInterval);
      }

      // Complete all steps
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step1').classList.add('completed');
      document.getElementById('step2').classList.remove('active');
      document.getElementById('step2').classList.add('completed');
      document.getElementById('step3').classList.add('completed');

      currentProgress = 100;
      document.getElementById('progressBarFill').style.width = '100%';
      document.getElementById('progressSubtext').textContent = 'üéâ Driver confirmed!';

      // Hide cancel request button
      document.getElementById('cancelRequestSection').style.display = 'none';
    }

    function showDriverDetails(ride) {
      if (!ride.driver) return;

      const driverSection = document.getElementById('driverSection');

      // Set driver info
      document.getElementById('driverAvatar').textContent = ride.driver.name.charAt(0).toUpperCase();
      document.getElementById('driverName').textContent = ride.driver.name;
      document.getElementById('driverPhone').textContent = 'üìû ' + (ride.driver.phone || 'Not available');

      // Set vehicle info
      const vehicleEmoji = {
        'Bike': 'üèçÔ∏è',
        'Auto': 'üõ∫',
        'Car': 'üöó',
        'SUV': 'üöô',
        'Carpool': 'üöï',
        'Shuttle': 'üöê'
      }[ride.driver.vehicle?.type] || 'üöó';

      const vehicleInfoHtml = `
        <div class="vehicle-badge">${vehicleEmoji} ${ride.driver.vehicle?.type || 'N/A'}</div>
        <div class="vehicle-badge">${ride.driver.vehicle?.model || 'N/A'}</div>
        <div class="vehicle-badge">${ride.driver.vehicle?.number || 'N/A'}</div>
        ${ride.driver.vehicle?.color ? `<div class="vehicle-badge">${ride.driver.vehicle.color}</div>` : ''}
      `;
      document.getElementById('vehicleInfo').innerHTML = vehicleInfoHtml;

      // Show OTP if available
      if (ride.otp) {
        document.getElementById('otpCard').style.display = 'block';
        document.getElementById('otpValue').textContent = ride.otp;
      }

      // Show driver section
      driverSection.classList.add('show');
    }

    // OSRM Routing Helper Function
    // OSRM Routing Helper Function
    async function drawOSRMRoute(start, end) {
      try {
        // Use Shared Routing Helper (Client-First -> Backend Proxy -> Fallback)
        if (!window.RapidRideRouting) {
          console.error('RapidRideRouting not loaded');
          return;
        }

        const route = await RapidRideRouting.getRoute(
          { lat: start[0], lng: start[1] },
          { lat: end[0], lng: end[1] }
        );

        if (route) {
          // Convert GeoJSON coordinates to Leaflet format [lat, lng]
          const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);

          // Draw the route on the map
          if (routeLine) {
            map.removeLayer(routeLine);
          }

          routeLine = L.polyline(coordinates, {
            color: '#8b5cf6',
            weight: 5,
            opacity: 0.7
          }).addTo(map);

          // Fit map to show full route with padding
          map.fitBounds(routeLine.getBounds(), {
            padding: [50, 50]
          });
        }
      } catch (error) {
        console.error('Error drawing route:', error);
      }
    } weight: 4,
      opacity: 0.7,
        lineJoin: 'round'
          }).addTo(map);

    console.log('‚úÖ OSRM route drawn successfully');
        } else {
      throw new Error('No route found');
    }
      } catch (error) {
      console.error('Error fetching OSRM route:', error);
      console.log('Falling back to straight line');

      // Fallback to straight line if OSRM fails
      if (routeLine) {
        map.removeLayer(routeLine);
      }

      routeLine = L.polyline([start, end], {
        color: '#8b5cf6',
        weight: 4,
        opacity: 0.7,
        dashArray: '10, 5' // Dashed to indicate it's not real route
      }).addTo(map);
    }
    }

    async function initializeMap(ride) {
      const mapSection = document.getElementById('mapSection');
      mapSection.classList.add('show');

      // Initialize Leaflet map
      if (map) {
        map.remove();
      }

      map = L.map('map').setView(
        [ride.pickup.lat, ride.pickup.lng],
        13
      );

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Add pickup marker
      const pickupIcon = L.divIcon({
        html: '<div style="font-size: 2rem;">üìç</div>',
        className: 'custom-marker',
        iconSize: [40, 40],
        iconAnchor: [20, 40]
      });
      pickupMarker = L.marker([ride.pickup.lat, ride.pickup.lng], { icon: pickupIcon })
        .addTo(map)
        .bindPopup('Pickup Location');

      // Add dropoff marker
      const dropIcon = L.divIcon({
        html: '<div style="font-size: 2rem;">üéØ</div>',
        className: 'custom-marker',
        iconSize: [40, 40],
        iconAnchor: [20, 40]
      });
      dropMarker = L.marker(
        [ride.dropoff?.lat || ride.destination?.lat, ride.dropoff?.lng || ride.destination?.lng],
        { icon: dropIcon }
      )
        .addTo(map)
        .bindPopup('Drop Location');

      // Draw route using OSRM for real navigation
      await drawOSRMRoute(
        [ride.pickup.lat, ride.pickup.lng],
        [ride.dropoff?.lat || ride.destination?.lat, ride.dropoff?.lng || ride.destination?.lng]
      );

      // Add driver marker if location available
      if (ride.driver && ride.driver.currentLocation) {
        const lat = ride.driver.currentLocation.lat;
        const lng = ride.driver.currentLocation.lng || ride.driver.currentLocation.lon;

        if (lat && lng) {
          const vehicleEmoji = {
            'Bike': 'üèçÔ∏è',
            'Auto': 'üõ∫',
            'Car': 'üöó',
            'SUV': 'üöô',
            'Carpool': 'üöï',
            'Shuttle': 'üöê'
          }[ride.driver.vehicle?.type] || 'üöó';

          const driverIcon = L.divIcon({
            html: `<div style="font-size: 2rem;">${vehicleEmoji}</div>`,
            className: 'custom-marker',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
          });

          driverMarker = L.marker(
            [lat, lng],
            { icon: driverIcon }
          ).addTo(map);
        }
      }

      // Fit bounds to show all markers
      const bounds = L.latLngBounds([
        [ride.pickup.lat, ride.pickup.lng],
        [ride.dropoff?.lat || ride.destination?.lat, ride.dropoff?.lng || ride.destination?.lng]
      ]);

      if (ride.driver && ride.driver.currentLocation) {
        const dLat = ride.driver.currentLocation.lat;
        const dLng = ride.driver.currentLocation.lng || ride.driver.currentLocation.lon;
        if (dLat && dLng) {
          bounds.extend([dLat, dLng]);
        }
      }
      map.fitBounds(bounds, { padding: [50, 50] });
    }

    async function initSocket() {
      // Get Firebase token for socket authentication
      let token = null;
      try {
        if (firebase && firebase.auth && firebase.auth().currentUser) {
          token = await firebase.auth().currentUser.getIdToken();
        }
      } catch (err) {
        console.error('Failed to get Firebase token for socket:', err);
      }

      socket = io(API_CONFIG.WS_URL, {
        auth: { token }
      });

      socket.on('connect', () => {
        console.log('‚úÖ Socket connected');
        if (currentRide && currentRide._id) {
          socket.emit('join-ride', currentRide._id);
        }
      });

      socket.on('ride:accepted', (data) => {
        console.log('Ride accepted by driver:', data);

        // Update current ride with driver info
        if (currentRide && data.rideId === currentRide._id) {
          currentRide.driver = data.driver;
          currentRide.otp = data.otp;
          currentRide.status = 'accepted';

          // Update UI
          completeProgressBar();
          showDriverDetails(currentRide);
          initializeMap(currentRide);
        } else {
          // Reload from API if data doesn't match
          loadCurrentRide();
        }
      });

      socket.on('ride:status-changed', (data) => {
        console.log('Ride status changed:', data);
        if (currentRide && data.rideId === currentRide._id) {
          currentRide.status = data.status;
          displayRideStatus(currentRide);
        }
      });

      socket.on('ride:arrived', (data) => {
        console.log('Driver arrived at pickup:', data);
        if (currentRide && data.rideId === currentRide._id) {
          currentRide.status = 'arrived';
          showToast('Driver Arrived', 'Your driver has reached the pickup point!', 'success');

          // Update progress header
          const progressHeader = document.querySelector('.progress-header h2');
          const progressSubtext = document.getElementById('progressSubtext');
          if (progressHeader) progressHeader.textContent = 'üëã Driver at Pickup';
          if (progressSubtext) progressSubtext.textContent = 'Your driver is waiting for you';
        }
      });

      socket.on('ride:started', (data) => {
        console.log('Ride started:', data);
        if (currentRide && data.rideId === currentRide._id) {
          currentRide.status = 'started';
          showToast('Ride Started', 'Your ride has started. Have a safe journey!', 'success');

          // Update progress header
          const progressHeader = document.querySelector('.progress-header h2');
          const progressSubtext = document.getElementById('progressSubtext');
          if (progressHeader) progressHeader.textContent = 'üöÄ Ride in Progress';
          if (progressSubtext) progressSubtext.textContent = 'Your driver is taking you to your destination';
        }
      });

      socket.on('ride:completed', (data) => {
        console.log('Ride completed:', data);
        if (currentRide && (data.rideId === currentRide._id || data.rideId.toString() === currentRide._id.toString())) {
          currentRide.status = 'completed';
          showToast('Ride Completed', 'Your ride has been completed successfully!', 'success');

          // Show rating modal after 1 second
          setTimeout(() => {
            showRatingModal(currentRide);
          }, 1000);
        }
      });

      socket.on('driver:location-update', (data) => {
        if (driverMarker && data.rideId === currentRide?._id) {
          driverMarker.setLatLng([data.location.lat, data.location.lng]);
        }
      });

      socket.on('ride:cancelled', (data) => {
        if (currentRide && data.rideId === currentRide._id) {
          showToast('Ride Cancelled', 'Your ride has been cancelled by the driver. Redirecting...', 'error');
          setTimeout(() => {
            window.location.href = 'book_ride.html';
          }, 2000);
        }
      });
    }

    function showCancelModal() {
      document.getElementById('cancelModal').classList.add('show');
    }

    function hideCancelModal() {
      document.getElementById('cancelModal').classList.remove('show');
    }

    async function confirmCancel() {
      console.log('confirmCancel called');
      console.log('currentRide:', currentRide);

      if (!currentRide) {
        showToast('No Active Ride', 'There is no active ride to cancel', 'error');
        hideCancelModal();
        return;
      }

      // Get ride ID - handle both _id and id properties
      const rideIdToCancel = currentRide._id || currentRide.id || rideId;
      console.log('Cancelling ride ID:', rideIdToCancel);

      try {
        const response = await apiFetch(`/rides/${rideIdToCancel}/cancel`, {
          method: 'POST'
        });

        const data = response.data;
        console.log('Cancel response:', data);

        if (!response.ok) {
          throw new Error(data.message || 'Failed to cancel ride');
        }

        hideCancelModal();
        showToast('Ride Cancelled', 'Your ride has been cancelled successfully. Redirecting...', 'success');
        setTimeout(() => {
          window.location.href = 'book_ride.html';
        }, 2000);
      } catch (error) {
        console.error('Error cancelling ride:', error);
        showToast('Cancellation Failed', error.message, 'error');
        hideCancelModal();
      }
    }

    function callDriver() {
      if (currentRide && currentRide.driver && currentRide.driver.phone) {
        window.location.href = `tel:${currentRide.driver.phone}`;
      } else {
        showToast('Phone Unavailable', 'Driver phone number is not available yet', 'warning');
      }
    }

    function goBack() {
      window.location.href = 'rider_home.html';
    }

    // Toast notification functions
    function showToast(title, message, type = 'info') {
      const toast = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      const toastTitle = document.getElementById('toastTitle');
      const toastText = document.getElementById('toastText');

      // Set icon based on type
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è',
        warning: '‚ö†Ô∏è'
      };

      toastIcon.textContent = icons[type] || icons.info;
      toastTitle.textContent = title;
      toastText.textContent = message;

      // Remove existing type classes
      toast.classList.remove('success', 'error', 'info', 'warning');
      toast.classList.add(type);
      toast.classList.add('show');

      // Auto hide after 4 seconds
      setTimeout(() => {
        hideToast();
      }, 4000);
    }

    function hideToast() {
      const toast = document.getElementById('toastMessage');
      toast.classList.remove('show');
    }

    // Rating Modal Functions
    let selectedRating = 0;
    let completedRideId = null;

    function showRatingModal(ride) {
      completedRideId = ride._id;
      const overlay = document.getElementById('ratingModalOverlay');

      // Update driver info
      if (ride.driver) {
        const driverAvatar = document.getElementById('driverAvatarRating');
        const driverName = document.getElementById('driverNameRating');
        const driverVehicle = document.getElementById('driverVehicleRating');

        driverAvatar.textContent = ride.driver.name.charAt(0).toUpperCase();
        driverName.textContent = ride.driver.name;
        driverVehicle.textContent = `${ride.driver.vehicle?.make || ''} ${ride.driver.vehicle?.model || ''} ‚Ä¢ ${ride.driver.vehicle?.plate || ''}`.trim();
      }

      // Reset rating
      selectedRating = 0;
      document.getElementById('feedbackText').value = '';
      document.getElementById('btnSubmitRating').disabled = true;

      // Setup star click handlers
      const stars = document.querySelectorAll('.star');
      stars.forEach(star => {
        star.classList.remove('active');
        star.onclick = () => selectRating(parseInt(star.dataset.rating));
      });

      overlay.classList.add('active');
    }

    function selectRating(rating) {
      selectedRating = rating;

      // Update stars
      const stars = document.querySelectorAll('.star');
      stars.forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        if (starRating <= rating) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });

      // Enable submit button
      document.getElementById('btnSubmitRating').disabled = false;
    }

    async function submitRating() {
      if (!selectedRating || !completedRideId) return;

      const feedback = document.getElementById('feedbackText').value.trim();
      const submitBtn = document.getElementById('btnSubmitRating');

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        const response = await apiFetch(`/rides/${completedRideId}/rate`, {
          method: 'POST',
          body: {
            rating: selectedRating,
            feedback: feedback
          }
        });

        if (response.ok) {
          closeRatingModal();
          showToast('Thank You!', 'Your rating has been submitted successfully', 'success');
          setTimeout(() => {
            window.location.href = 'rider_home.html';
          }, 2000);
        } else {
          showToast('Error', response.data?.message || 'Failed to submit rating', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Rating';
        }
      } catch (error) {
        console.error('Error submitting rating:', error);
        showToast('Error', 'Failed to submit rating. Please try again.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Rating';
      }
    }

    function skipRating() {
      closeRatingModal();
      showToast('Skipped', 'You can rate this ride later from your ride history', 'info');
      setTimeout(() => {
        window.location.href = 'rider_home.html';
      }, 2000);
    }

    function closeRatingModal() {
      const overlay = document.getElementById('ratingModalOverlay');
      overlay.classList.remove('active');
      selectedRating = 0;
      completedRideId = null;
    }
  </script>
</body>

</html>