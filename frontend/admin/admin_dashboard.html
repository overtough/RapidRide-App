<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Dashboard ‚Äî RapidRide</title>
  <link rel="stylesheet" href="../common/css/global.css">
  <style>
    body {
      padding: 0;
      margin: 0;
      min-height: 100vh;
    }

    .admin-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .admin-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .admin-badge {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      color: white;
    }

    .admin-logout {
      padding: 0.5rem 1.25rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 8px;
      color: #fca5a5;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .admin-logout:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: scale(1.05);
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .admin-header {
      margin-bottom: 2rem;
    }

    .admin-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .admin-subtitle {
      color: var(--text-muted);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 1.5rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }

    .section {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--glass-border);
      padding-bottom: 0.5rem;
    }

    .tab {
      padding: 0.5rem 1.25rem;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab.active {
      background: rgba(139, 92, 246, 0.2);
      color: var(--primary);
    }

    .tab:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--glass-border);
    }

    .data-table th {
      font-weight: 700;
      color: var(--text-muted);
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    .data-table tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge.success {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .badge.warning {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
    }

    .badge.danger {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .badge.info {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .badge.muted {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    /* Chat Modal Styles */
    .chat-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .chat-modal.active {
      display: flex;
      opacity: 1;
    }

    .chat-modal-content {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      height: 700px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .chat-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-user-info h3 {
      margin: 0 0 0.25rem 0;
      font-size: 1.25rem;
    }

    .chat-user-info p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .chat-message {
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .chat-message.admin {
      flex-direction: row-reverse;
    }

    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), #7c3aed);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .chat-message.admin .chat-avatar {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .chat-bubble {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.75rem 1rem;
      border-radius: 12px;
      max-width: 70%;
      word-wrap: break-word;
    }

    .chat-message.admin .chat-bubble {
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .chat-time {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .chat-input-container {
      padding: 1.5rem 2rem;
      border-top: 1px solid var(--glass-border);
      display: flex;
      gap: 1rem;
    }

    .chat-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      color: white;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      font-family: inherit;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .chat-send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--primary);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .chat-send-btn:hover {
      transform: scale(1.05);
      background: #7c3aed;
    }

    .chat-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chat-close:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .chat-close svg {
      width: 18px;
      height: 18px;
    }

    .ticket-row {
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .ticket-row:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .filter-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-btn.active {
      background: rgba(139, 92, 246, 0.2);
      border-color: var(--primary);
      color: var(--primary);
    }

    .filter-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.08);
    }
  </style>
</head>
<body>
  <header class="admin-topbar">
    <div class="admin-brand">
      <span>üîê RapidRide Admin</span>
      <span class="admin-badge">SUPER ADMIN</span>
    </div>
    <button class="admin-logout" onclick="logout()">Logout</button>
  </header>

  <main class="admin-container">
    <div class="admin-header">
      <h1 class="admin-title">Admin Dashboard</h1>
      <p class="admin-subtitle">Welcome back, Administrator</p>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card" style="cursor: pointer;" onclick="document.getElementById('userManagementSection').scrollIntoView({ behavior: 'smooth' })">
        <div class="stat-label">Total Users</div>
        <div class="stat-value" id="totalUsers">0</div>
      </div>
      <div class="stat-card" style="cursor: pointer;" onclick="window.location.href='ride_management.html#all-rides'">
        <div class="stat-label">Total Rides</div>
        <div class="stat-value" id="totalRides">0</div>
      </div>
      <div class="stat-card" style="cursor: pointer;" onclick="document.getElementById('supportTicketsSection').scrollIntoView({ behavior: 'smooth' })">
        <div class="stat-label">Support Tickets</div>
        <div class="stat-value" id="supportTickets">0</div>
      </div>
    </div>

    <!-- User Management -->
    <section class="section" id="userManagementSection">
      <h2 class="section-title">
        <span>üë•</span>
        User Management
      </h2>
      
      <div class="tabs">
        <button class="tab active" onclick="switchTab('riders')">Riders</button>
        <button class="tab" onclick="switchTab('drivers')">Drivers</button>
      </div>

      <div id="riders-tab" class="tab-content active">
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Total Rides</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="ridersTableBody">
            <tr>
              <td colspan="5">
                <div class="empty-state">Loading riders...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="drivers-tab" class="tab-content">
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Vehicle</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="driversTableBody">
            <tr>
              <td colspan="5">
                <div class="empty-state">Loading drivers...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Support Tickets -->
    <section class="section" id="supportTicketsSection">
      <h2 class="section-title">
        <span>üí¨</span>
        Support Tickets
      </h2>
      
      <div class="filter-buttons">
        <button class="filter-btn active" onclick="filterChats('all')">All</button>
        <button class="filter-btn" onclick="filterChats('active')">Active</button>
        <button class="filter-btn" onclick="filterChats('ended')">Ended</button>
        <button class="filter-btn" onclick="filterChats('captain')">Captains</button>
        <button class="filter-btn" onclick="filterChats('rider')">Riders</button>
      </div>

      <table class="data-table">
        <thead>
          <tr>
            <th>Ticket</th>
            <th>User</th>
            <th>Type</th>
            <th>Last Message</th>
            <th>Status</th>
            <th>Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="ticketsTableBody">
          <tr>
            <td colspan="7">
              <div class="empty-state">Loading support tickets...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </section>
  </main>

  <!-- Chat Modal -->
  <div class="chat-modal" id="chatModal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <button onclick="closeChatModal()" style="padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; margin-right: 0.75rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
        </button>
        <div class="chat-user-info">
          <h3 id="chatUserName">Loading...</h3>
          <p id="chatTicketInfo">Ticket: #000000</p>
        </div>
        <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
          <button id="adminEndChatBtn" onclick="showEndChatConfirmation()" style="padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 8px; color: #ef4444; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; margin-left: 0.5rem;">
            End Chat
          </button>
          <div class="chat-close" onclick="closeChatModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </div>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="empty-state">Loading messages...</div>
      </div>
      <div class="chat-input-container">
        <textarea class="chat-input" id="chatInput" placeholder="Type your reply..." rows="1"></textarea>
        <button class="chat-send-btn" onclick="sendAdminMessage()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- End Chat Confirmation Modal -->
  <div id="endChatConfirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 2rem; max-width: 400px; width: 90%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
      <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; color: white;">End Chat Confirmation</h3>
      <p style="margin: 0 0 1.5rem 0; color: rgba(255, 255, 255, 0.8); line-height: 1.5;">
        Are you sure you want to end this chat? This action cannot be undone and no further messages can be sent.
      </p>
      <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
        <button onclick="hideEndChatConfirmation()" style="padding: 0.75rem 1.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
          Cancel
        </button>
        <button onclick="confirmEndChat()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #ef4444, #dc2626); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
          End Chat
        </button>
      </div>
    </div>
  </div>

  <script src="../common/js/auth.js"></script>
  <script>
    // Override Auth.logout to track who's calling it
    const originalLogout = Auth.logout;
    Auth.logout = function() {
      console.error('‚ö†Ô∏è LOGOUT CALLED!');
      console.trace('Logout call stack:');
      return originalLogout.apply(this, arguments);
    };

    // Disable aggressive popstate logout for admin
    window.addEventListener('popstate', function(e) {
      console.log('üõë Blocked popstate event');
      e.stopImmediatePropagation();
      e.preventDefault();
      return false;
    }, true);

    // Block all navigation that might trigger logout
    window.addEventListener('beforeunload', function(e) {
      console.log('beforeunload triggered - preserving token');
      preserveToken();
    });

    // Prevent aggressive logout - save token to session storage as backup
    function preserveToken() {
      const token = localStorage.getItem('token');
      if (token) {
        sessionStorage.setItem('token_backup', token);
        document.cookie = `admin_token=${token}; path=/; max-age=${30*24*60*60}`; // 30 days
        console.log('‚úÖ Token preserved');
      }
    }

    function restoreToken() {
      let token = localStorage.getItem('token');
      console.log('Checking token - localStorage:', !!token);
      
      if (!token) {
        // Try session storage
        token = sessionStorage.getItem('token_backup');
        console.log('Checking token - sessionStorage:', !!token);
        if (token) {
          localStorage.setItem('token', token);
          console.log('‚úÖ Restored token from session storage');
        } else {
          // Try cookie
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'admin_token') {
              token = value;
              localStorage.setItem('token', token);
              sessionStorage.setItem('token_backup', token);
              console.log('‚úÖ Restored token from cookie');
              break;
            }
          }
        }
      }
      return token;
    }

    // Monitor localStorage changes
    window.addEventListener('storage', function(e) {
      if (e.key === 'token') {
        console.error('‚ö†Ô∏è localStorage "token" changed!', 'Old:', e.oldValue, 'New:', e.newValue);
        if (!e.newValue) {
          console.error('üö® TOKEN WAS DELETED! Restoring...');
          restoreToken();
        }
      }
    });

    // Check admin authentication
    window.addEventListener('load', async () => {
      try {
        console.log('Checking admin authentication...');
        
        // Restore token if missing
        const token = restoreToken();
        console.log('Token exists:', !!token);
        
        if (!token) {
          console.error('No token found anywhere, redirecting to signin');
          window.location.href = '../common/signin.html';
          return;
        }
        
        let user;
        try {
          await Auth.populateFromServer();
          user = Auth.currentUser();
          console.log('Current user from server:', user);
        } catch (apiError) {
          console.error('API failed but token exists - staying logged in:', apiError);
          // Don't redirect on API failure - token still exists
          user = { role: 'admin' }; // Temporary fallback
        }
        
        if (!user) {
          console.error('No user found, but token exists - trying again in 2 seconds...');
          // Don't immediately redirect - give it another chance
          setTimeout(() => window.location.reload(), 2000);
          return;
        }

        // Check if user has admin role
        if (user.role !== 'admin') {
          console.error('User role is not admin:', user.role);
          alert('Access denied. Admin privileges required.');
          window.location.href = user.role === 'captain' ? '../driver/driver_home.html' : '../rider/rider_home.html';
          return;
        }

        console.log('‚úÖ Admin authenticated successfully');
        preserveToken(); // Backup token
        
        // Load dashboard data
        try {
          await loadDashboardData();
        } catch (loadError) {
          console.error('Failed to load dashboard data:', loadError);
          // Don't logout - just show error
          document.getElementById('ticketsTableBody').innerHTML = `
            <tr><td colspan="7"><div class="empty-state">Failed to load. Will retry...</div></td></tr>
          `;
          setTimeout(() => loadDashboardData(), 5000);
        }
      } catch (error) {
        console.error('Critical error:', error);
        // Only redirect if token is actually missing
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '../common/signin.html';
        } else {
          console.log('Token still exists - reloading page instead of logout');
          setTimeout(() => window.location.reload(), 2000);
        }
      }
    });

    // Preserve token periodically
    setInterval(preserveToken, 5000);

    async function logout() {
      if (confirm('Are you sure you want to logout?')) {
        await Auth.logout();
        window.location.href = '../common/signin.html';
      }
    }

    function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tab}-tab`).classList.add('active');
    }

    // Chat management variables
    let allChats = [];
    let currentChatId = null;
    let currentFilter = 'all';
    let messagePollingInterval = null;

    async function loadDashboardData() {
      try {
        const token = localStorage.getItem('token');
        
        // Fetch users from backend
        const response = await fetch(\${API_CONFIG.BASE_URL}/auth/admin/users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update stats
          const totalUsers = data.riders.length + data.captains.length;
          document.getElementById('totalUsers').textContent = totalUsers;
          
          // Fetch total rides count
          fetchTotalRides();

          // Load riders
          const ridersBody = document.getElementById('ridersTableBody');
          if (data.riders.length > 0) {
            ridersBody.innerHTML = data.riders.map(rider => `
              <tr>
                <td>${rider.name}</td>
                <td>${rider.email}</td>
                <td>${rider.phone || 'N/A'}</td>
                <td>0</td>
                <td><span class="badge ${rider.emailVerified ? 'success' : 'muted'}">${rider.emailVerified ? 'Active' : 'Pending'}</span></td>
              </tr>
            `).join('');
          } else {
            ridersBody.innerHTML = `
              <tr>
                <td colspan="5">
                  <div class="empty-state">
                    <p>No riders registered yet</p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">Riders will appear here once they register</p>
                  </div>
                </td>
              </tr>
            `;
          }

          // Load drivers
          const driversBody = document.getElementById('driversTableBody');
          if (data.captains.length > 0) {
            driversBody.innerHTML = data.captains.map(driver => `
              <tr>
                <td>${driver.name}</td>
                <td>${driver.email}</td>
                <td>${driver.phone || 'N/A'}</td>
                <td>N/A</td>
                <td><span class="badge ${driver.emailVerified ? 'success' : 'muted'}">${driver.emailVerified ? 'Active' : 'Pending'}</span></td>
              </tr>
            `).join('');
          } else {
            driversBody.innerHTML = `
              <tr>
                <td colspan="5">
                  <div class="empty-state">
                    <p>No drivers registered yet</p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">Drivers will appear here once they register</p>
                  </div>
                </td>
              </tr>
            `;
          }
        }
      } catch (error) {
        console.error('Failed to load dashboard data:', error);
      }

      // Load support tickets
      await loadSupportTickets();
    }

    async function loadSupportTickets() {
      try {
        const token = localStorage.getItem('token');
        console.log('Loading support tickets...');
        console.log('Token:', token ? 'Present' : 'Missing');
        
        const response = await fetch(\${API_CONFIG.BASE_URL}/support/admin/chats', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
          allChats = data.chats;
          console.log('Loaded chats:', allChats.length);
          document.getElementById('supportTickets').textContent = allChats.filter(c => c.status === 'active').length;
          renderChats();
        } else {
          console.error('Failed to load chats:', data.message);
          document.getElementById('ticketsTableBody').innerHTML = `
            <tr>
              <td colspan="7">
                <div class="empty-state">${data.message || 'Failed to load tickets'}</div>
              </td>
            </tr>
          `;
        }
      } catch (error) {
        console.error('Failed to load support tickets:', error);
        document.getElementById('ticketsTableBody').innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">Failed to load tickets. Please refresh.</div>
            </td>
          </tr>
        `;
      }
    }

    function filterChats(filter) {
      currentFilter = filter;
      
      // Update filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      renderChats();
    }

    function renderChats() {
      let filteredChats = allChats;
      
      if (currentFilter === 'active' || currentFilter === 'ended') {
        filteredChats = allChats.filter(c => c.status === currentFilter);
      } else if (currentFilter === 'captain' || currentFilter === 'rider') {
        filteredChats = allChats.filter(c => c.userType === currentFilter);
      }

      const tbody = document.getElementById('ticketsTableBody');
      
      if (filteredChats.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">No ${currentFilter === 'all' ? '' : currentFilter} tickets found</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredChats.map(chat => `
        <tr class="ticket-row" onclick="openChatModal('${chat.chatId}')">
          <td><strong>${chat.ticketNumber}</strong></td>
          <td>${chat.userName}</td>
          <td><span class="badge ${chat.userType === 'captain' ? 'warning' : chat.userType === 'rider' ? 'info' : 'muted'}">${chat.userType}</span></td>
          <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            ${chat.lastMessage || 'No messages yet'}
          </td>
          <td><span class="badge ${chat.status === 'active' ? 'success' : 'muted'}">${chat.status}</span></td>
          <td>${new Date(chat.createdAt).toLocaleDateString()}</td>
          <td>
            <button class="badge" style="background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); color: white;" onclick="event.stopPropagation(); openChatModal('${chat.chatId}')">
              View
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function openChatModal(chatId) {
      currentChatId = chatId;
      const modal = document.getElementById('chatModal');
      modal.classList.add('active');
      
      await loadChatMessages(chatId);
      startMessagePolling();
      
      setTimeout(() => {
        document.getElementById('chatInput').focus();
      }, 100);
    }

    function closeChatModal() {
      const modal = document.getElementById('chatModal');
      modal.classList.remove('active');
      
      if (messagePollingInterval) {
        clearInterval(messagePollingInterval);
        messagePollingInterval = null;
      }
      
      currentChatId = null;
    }

    async function loadChatMessages(chatId) {
      try {
        console.log('Loading messages for chat:', chatId);
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_CONFIG.BASE_URL}/support/chats/${chatId}?_t=${Date.now()}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        console.log('Message response status:', response.status);
        const data = await response.json();
        console.log('Message response data:', data);
        
        if (data.success) {
          const chat = data.chat;
          console.log('Chat messages:', chat.messages);
          
          // Update header
          document.getElementById('chatUserName').textContent = `${chat.userName} (${chat.userType})`;
          document.getElementById('chatTicketInfo').textContent = `Ticket: ${chat.ticketNumber} ‚Ä¢ ${chat.status}`;
          
          // Hide input container and end button if chat is ended
          const inputContainer = document.querySelector('.chat-modal .chat-input-container');
          const endBtn = document.getElementById('adminEndChatBtn');
          
          if (chat.status === 'ended') {
            inputContainer.style.display = 'none';
            if (endBtn) endBtn.style.display = 'none';
          } else {
            inputContainer.style.display = 'flex';
            if (endBtn) endBtn.style.display = 'block';
          }
          
          // Render messages
          const messagesContainer = document.getElementById('chatMessages');
          messagesContainer.innerHTML = '';
          
          if (chat.messages.length === 0) {
            messagesContainer.innerHTML = '<div class="empty-state">No messages yet</div>';
            return;
          }
          
          chat.messages.forEach(msg => {
            const isAdmin = msg.senderType === 'admin';
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${isAdmin ? 'admin' : ''}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'chat-avatar';
            avatar.textContent = isAdmin ? 'A' : (chat.userType === 'captain' ? 'D' : 'R');
            
            const content = document.createElement('div');
            content.style.flex = '1';
            
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.textContent = msg.text;
            
            const time = document.createElement('div');
            time.className = 'chat-time';
            time.textContent = new Date(msg.timestamp).toLocaleTimeString('en-US', { 
              hour: '2-digit', 
              minute: '2-digit' 
            });
            
            content.appendChild(bubble);
            content.appendChild(time);
            messageEl.appendChild(avatar);
            messageEl.appendChild(content);
            
            messagesContainer.appendChild(messageEl);
          });
          
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      } catch (error) {
        console.error('Failed to load messages:', error);
      }
    }

    function startMessagePolling() {
      if (messagePollingInterval) {
        clearInterval(messagePollingInterval);
      }
      messagePollingInterval = setInterval(() => {
        if (currentChatId) {
          loadChatMessages(currentChatId);
        }
      }, 5000);
    }

    async function sendAdminMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || !currentChatId) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_CONFIG.BASE_URL}/support/chats/${currentChatId}/messages`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        if (data.success) {
          input.value = '';
          input.style.height = 'auto';
          await loadChatMessages(currentChatId);
          await loadSupportTickets(); // Refresh ticket list
        }
      } catch (error) {
        console.error('Failed to send message:', error);
        alert('Failed to send message. Please try again.');
      }
    }

    // Auto-resize textarea
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
      chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendAdminMessage();
        }
      });
    }

    // End chat confirmation functions
    function showEndChatConfirmation() {
      document.getElementById('endChatConfirmModal').style.display = 'flex';
    }

    function hideEndChatConfirmation() {
      document.getElementById('endChatConfirmModal').style.display = 'none';
    }

    async function confirmEndChat() {
      if (!currentChatId) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_CONFIG.BASE_URL}/support/chats/${currentChatId}/end`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        if (data.success) {
          hideEndChatConfirmation();
          await loadChatMessages(currentChatId); // Reload to show ended state
          await loadSupportTickets(); // Refresh ticket list
        } else {
          alert('Failed to end chat: ' + (data.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Failed to end chat:', error);
        alert('Failed to end chat. Please try again.');
      }
    }

    // Close modal on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeChatModal();
      }
    });

    // Auto-refresh tickets every 30 seconds
    setInterval(async () => {
      if (!document.getElementById('chatModal').classList.contains('active')) {
        await loadSupportTickets();
      }
    }, 30000);

    // Fetch total rides count
    async function fetchTotalRides() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(\${API_CONFIG.BASE_URL}/rides/admin/count', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('totalRides').textContent = data.count || 0;
        } else {
          console.error('Failed to fetch total rides count');
          document.getElementById('totalRides').textContent = '0';
        }
      } catch (error) {
        console.error('Error fetching total rides:', error);
        document.getElementById('totalRides').textContent = '0';
      }
    }
  </script>
</body>
</html>
