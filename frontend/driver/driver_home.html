<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Driver Dashboard — RapidRide</title>
  <link rel="stylesheet" href="../common/css/global.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="../common/js/config.js"></script>
  <style>
    body {
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--bg-surface);
    }

    /* Top Bar: Status & Earnings */
    .driver-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-surface);
      z-index: 10;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      font-size: 0.9rem;
      padding: 0.4rem 0.8rem;
      background: var(--bg-app);
      border-radius: var(--radius-pill);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
    }

    .status-dot.online {
      background: var(--success);
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }

    .earnings-display {
      text-align: right;
    }

    .earnings-amount {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--primary);
    }

    .earnings-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Main Area: Map */
    .map-container {
      flex: 1;
      position: relative;
      background: #e5e5e5;
    }

    /* Floating Request Card */
    .requests-container {
      position: absolute;
      top: 1rem;
      left: 1rem;
      right: 1rem;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      pointer-events: none;
      /* Allow clicks through empty space */
    }

    .ride-request-card {
      pointer-events: auto;
      background: var(--primary);
      color: white;
      padding: 1.25rem;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-float);
      animation: slideUp 0.3s ease-out;
    }

    .req-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .req-price {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
    }

    .req-btn-row {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .btn-accept {
      flex: 1;
      background: var(--accent);
      color: var(--primary);
      border: none;
      padding: 0.75rem;
      border-radius: var(--radius-sm);
      font-weight: 700;
      cursor: pointer;
    }

    .btn-decline {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 0.75rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    /* Bottom Dock: GO ONLINE Toggle */
    .action-dock {
      padding: 1.5rem;
      background: var(--bg-surface);
      border-top: 1px solid var(--border);
      text-align: center;
      z-index: 10;
    }

    .toggle-btn {
      width: 100%;
      padding: 1.25rem;
      border-radius: var(--radius-pill);
      font-size: 1.2rem;
      font-weight: 800;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .toggle-btn.is-offline {
      background: var(--primary);
      color: white;
    }

    .toggle-btn.is-online {
      background: #EF4444;
      /* Red for Stop */
      color: white;
    }

    .offline-overlay {
      position: absolute;
      inset: 0;
      background: rgba(251, 249, 244, 0.8);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--text-secondary);
      font-size: 1.25rem;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>

  <!-- Header -->
  <header class="driver-header">
    <div class="status-badge">
      <div id="statusDot" class="status-dot"></div>
      <span id="statusText">Offline</span>
    </div>

    <div class="earnings-display">
      <div class="earnings-amount" id="todayEarnings">₹0</div>
      <div class="earnings-label">Today's Earnings</div>
    </div>
  </header>

  <!-- Map Area -->
  <div class="map-container">
    <div id="driverMap" style="width: 100%; height: 100%;"></div>

    <!-- Offline Shield -->
    <div id="offlineOverlay" class="offline-overlay">
      You are offline
    </div>

    <!-- Active Requests Feed -->
    <div id="requestFeed" class="requests-container">
      <!-- Requests will be injected here -->
    </div>
  </div>

  <!-- Bottom Action Dock -->
  <div class="action-dock">
    <button id="toggleBtn" class="toggle-btn is-offline">
      GO ONLINE
    </button>
    <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted); cursor: pointer;"
      onclick="window.location.href='../rider/profile.html'">
      Account & Settings
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script src="../common/js/firebase-config.js"></script>
  <script src="../common/js/config.js"></script>
  <script src="../common/js/auth.js"></script>
  <script src="../common/js/map.js"></script>
  <script src="js/driver_socket.js"></script>

  <script>
    // --- APP LOGIC ---
    let isOnline = false;
    let mapApi = null;
    let currentUser = null;

    // Initialize Map
    async function initMap() {
      if (typeof RRMap !== 'undefined') {
        mapApi = await RRMap.init('driverMap', { zoom: 14 });
        // Start centered on generic location until located
      }
    }
    initMap();

    // Toggle Online/Offline
    const toggleBtn = document.getElementById('toggleBtn');
    const overlay = document.getElementById('offlineOverlay');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');

    toggleBtn.addEventListener('click', async () => {
      if (!currentUser) return;

      if (isOnline) {
        // GO OFFLINE
        await goOffline();
      } else {
        // GO ONLINE
        await goOnline();
      }
    });

    async function goOnline() {
      if (!currentUser) return;

      try {
        // Socket Logic
        const vehicleType = currentUser.vehicle?.type || 'Sedan';
        DriverSocket.goOnline(currentUser.id, vehicleType);

        // Map Watch
        if (mapApi) {
          mapApi.startWatch(pos => {
            const { latitude, longitude } = pos.coords;
            DriverSocket.updateLocation(currentUser.id, { lat: latitude, lng: longitude });
          });
        }

        // UI Update
        isOnline = true;
        toggleBtn.textContent = "STOP";
        toggleBtn.className = "toggle-btn is-online";
        overlay.classList.add('hidden');
        statusDot.classList.add('online');
        statusText.textContent = "Online";

        // Save State
        localStorage.setItem('driver_online_state', JSON.stringify({ userId: currentUser.id, time: Date.now() }));

      } catch (e) {
        console.error(e);
        alert("Failed to go online");
      }
    }

    async function goOffline() {
      if (!currentUser) return;

      try {
        DriverSocket.goOffline(currentUser.id);
        if (mapApi) mapApi.stopWatch();

        isOnline = false;
        toggleBtn.textContent = "GO ONLINE";
        toggleBtn.className = "toggle-btn is-offline";
        overlay.classList.remove('hidden');
        statusDot.classList.remove('online');
        statusText.textContent = "Offline";

        localStorage.removeItem('driver_online_state');
        document.getElementById('requestFeed').innerHTML = ''; // Clear requests

      } catch (e) {
        console.error(e);
      }
    }

    // Auth & Data Loading
    Auth.populateFromServer().then(async user => {
      currentUser = user;
      if (user) {
        updateStats();

        // Auto-go online on page load
        // Small delay to ensure socket connection
        setTimeout(goOnline, 1000);
      }
    });

    async function updateStats() {
      try {
        const res = await window.apiFetch('/auth/stats/today');
        if (res.ok && res.data) {
          document.getElementById('todayEarnings').textContent = `₹${res.data.todayStats?.totalEarnings || 0}`;
        }
      } catch (e) { console.warn("Stats error", e); }
    }

    // Socket Interactions (Global Handler exposed for socket.js)
    window.updateRideRequests = function (requests) {
      const feed = document.getElementById('requestFeed');
      if (!isOnline) return;

      if (requests.length === 0) {
        feed.innerHTML = '';
        return;
      }

      feed.innerHTML = requests.map(req => `
            <div class="ride-request-card">
                <div class="req-header">
                    <span>${req.time || 'New Request'}</span>
                    <span class="req-price">₹${req.fare}</span>
                </div>
                <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">${req.distance.toFixed(1)} km away</div>
                <div style="font-size: 0.9rem; opacity: 0.8;">Pickup: ${req.pickup.address}</div>
                
                <div class="req-btn-row">
                    <button class="btn-decline" onclick="ignoreRequest('${req.rideId}')">Ignore</button>
                    <button class="btn-accept" onclick="acceptRideDirectly('${req.rideId}')">ACCEPT</button>
                </div>
            </div>
        `).join('');
    };

    window.acceptRideDirectly = async function (rideId) {
      try {
        const res = await window.apiFetch(`/rides/${rideId}/accept`, { method: 'POST' });
        if (res.ok) {
          window.location.href = `ride_active.html?rideId=${rideId}`;
        } else {
          alert("Failed to accept: " + (res.data?.message || "Unknown error"));
        }
      } catch (e) {
        alert("Error accepting ride");
      }
    };

    window.ignoreRequest = function (rideId) {
      // Just hide it locally for now? Or tell backend? 
      // For simple UI, just remove visually
      const el = document.querySelector(`button[onclick="ignoreRequest('${rideId}')"]`).closest('.ride-request-card');
      el.style.display = 'none';
    };

  </script>
</body>

</html>