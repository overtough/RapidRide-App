<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Active Ride ‚Äî RapidRide Driver</title>
  <link rel="stylesheet" href="../common/css/global.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      padding: 0;
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-border);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      color: var(--primary);
      transform: scale(1.1);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    /* Status Card */
    .status-card {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      text-align: center;
    }

    .status-card h2 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .status-card p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    /* Rider Info */
    .rider-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .rider-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #22c55e, #10b981);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .rider-details {
      flex: 1;
    }

    .rider-name {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    /* Map Section */
    .map-section {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .map-container {
      height: 400px;
      width: 100%;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .location-info {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .location-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
    }

    .location-icon {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .location-icon.pickup {
      background: rgba(34, 197, 94, 0.2);
      border: 2px solid #22c55e;
    }

    .location-icon.drop {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
    }

    .location-text {
      flex: 1;
    }

    .location-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .location-address {
      font-weight: 600;
    }

    /* Ride Details Grid */
    .ride-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .ride-detail-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 1.25rem;
      text-align: center;
    }

    .ride-detail-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .ride-detail-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    /* Action Buttons */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .btn-action {
      padding: 1.25rem;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-reached {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .btn-reached:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
    }

    .btn-call {
      background: rgba(34, 197, 94, 0.2);
      border: 2px solid #22c55e;
      color: #22c55e;
    }

    .btn-call:hover {
      background: rgba(34, 197, 94, 0.3);
      transform: translateY(-2px);
    }

    .btn-cancel {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
      color: #ef4444;
    }

    .btn-cancel:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: translateY(-2px);
    }

    /* OTP Modal */
    .otp-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .otp-modal.show {
      display: flex;
    }

    .otp-modal-content {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 2rem;
      max-width: 450px;
      width: 90%;
      text-align: center;
    }

    .otp-modal-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .otp-modal h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .otp-modal p {
      color: var(--text-muted);
      margin-bottom: 2rem;
    }

    .otp-input-container {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
    }

    .otp-input {
      width: 60px;
      height: 70px;
      font-size: 2rem;
      text-align: center;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--glass-border);
      border-radius: 12px;
      color: var(--text);
      font-weight: 700;
      font-family: 'Courier New', monospace;
    }

    .otp-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }

    .otp-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .btn-verify {
      padding: 1rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-verify:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
    }

    .btn-close-modal {
      padding: 1rem;
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      color: #ef4444;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-close-modal:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    /* Toast Message */
    .toast-message {
      position: fixed;
      top: 100px;
      right: 20px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      min-width: 300px;
      max-width: 400px;
      z-index: 10001;
      display: none;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: slideInRight 0.3s ease;
    }

    .toast-message.show {
      display: flex;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast-icon {
      font-size: 1.8rem;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 1rem;
    }

    .toast-text {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .toast-close {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2rem;
      color: var(--text-muted);
    }

    .toast-close:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }

    .toast-message.success {
      border-left: 4px solid #22c55e;
    }

    .toast-message.error {
      border-left: 4px solid #ef4444;
    }

    .toast-message.warning {
      border-left: 4px solid #fbbf24;
    }

    /* Complete Ride Modal */
    .complete-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .complete-modal.show {
      display: flex;
    }

    .complete-modal-content {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 2rem;
      max-width: 450px;
      width: 90%;
      text-align: center;
    }

    .complete-modal-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .complete-modal h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .complete-modal p {
      color: var(--text-muted);
      margin-bottom: 1.5rem;
    }

    .fare-display {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .fare-label {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }

    .fare-amount {
      font-size: 3rem;
      font-weight: 700;
    }

    .payment-reminder {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid #ffc107;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: #ffc107;
      font-size: 0.95rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .complete-modal-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .btn-confirm-complete {
      padding: 1rem;
      background: linear-gradient(135deg, #22c55e, #10b981);
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-confirm-complete:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);
    }

    .btn-cancel-complete {
      padding: 1rem;
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      color: #ef4444;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-cancel-complete:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    @media (max-width: 768px) {
      .action-buttons {
        grid-template-columns: 1fr;
      }

      .otp-input {
        width: 50px;
        height: 60px;
        font-size: 1.5rem;
      }

      .complete-modal-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <script src="../../../../../../../common/js/config.js"></script>
</head>

<body>
  <header class="topbar">
    <div class="topbar-left">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <strong>Active Ride</strong>
    </div>
  </header>

  <div class="container">
    <!-- Status Card -->
    <div class="status-card">
      <h2 id="statusHeading">üöó Navigate to Pickup</h2>
      <p id="statusSubtext">Head to the pickup location to meet your rider</p>
    </div>

    <!-- Rider Info -->
    <div class="rider-card">
      <div class="rider-avatar" id="riderAvatar">R</div>
      <div class="rider-details">
        <div class="rider-name" id="riderName">Loading...</div>
        <div style="color: var(--text-muted);">Waiting at pickup location</div>
      </div>
    </div>

    <!-- Ride Details -->
    <div class="ride-details-grid">
      <div class="ride-detail-card">
        <div class="ride-detail-label">Fare Amount</div>
        <div class="ride-detail-value" id="fareAmount">‚Çπ--</div>
      </div>
      <div class="ride-detail-card">
        <div class="ride-detail-label">Distance</div>
        <div class="ride-detail-value" id="distanceValue">-- km</div>
      </div>
      <div class="ride-detail-card">
        <div class="ride-detail-label">Duration</div>
        <div class="ride-detail-value" id="durationValue">-- min</div>
      </div>
    </div>

    <!-- Map Section -->
    <div class="map-section">
      <div class="location-info">
        <div class="location-item">
          <div class="location-icon pickup">üìç</div>
          <div class="location-text">
            <div class="location-label" id="locationLabel">Pickup Location</div>
            <div class="location-address" id="locationAddress">Loading...</div>
          </div>
        </div>
        <div class="location-item" id="dropLocationItem" style="display: none;">
          <div class="location-icon drop">üéØ</div>
          <div class="location-text">
            <div class="location-label">Drop Location</div>
            <div class="location-address" id="dropAddress">Loading...</div>
          </div>
        </div>
      </div>

      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn-action btn-reached" id="btnReached" onclick="markArrived()">
        ‚úÖ Reached Pickup Point
      </button>
      <button class="btn-action" onclick="openGoogleMapsNavigation()" style="background: #34a853;">
        üó∫Ô∏è Navigate with Google Maps
      </button>
      <button class="btn-action btn-call" onclick="callRider()">
        üìû Call Rider
      </button>
      <button class="btn-action btn-cancel" onclick="cancelRide()">
        ‚úñ Cancel Ride
      </button>
    </div>
  </div>

  <!-- OTP Verification Modal -->
  <div class="otp-modal" id="otpModal">
    <div class="otp-modal-content">
      <div class="otp-modal-icon">üîê</div>
      <h3>Enter OTP</h3>
      <p>Ask the rider for their 4-digit OTP to start the ride</p>

      <div class="otp-input-container">
        <input type="text" class="otp-input" maxlength="1" id="otp1" autofocus>
        <input type="text" class="otp-input" maxlength="1" id="otp2">
        <input type="text" class="otp-input" maxlength="1" id="otp3">
        <input type="text" class="otp-input" maxlength="1" id="otp4">
      </div>

      <div class="otp-buttons">
        <button class="btn-verify" onclick="verifyOTP()">
          Verify & Start Ride
        </button>
        <button class="btn-close-modal" onclick="closeOTPModal()">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Complete Ride Confirmation Modal -->
  <div class="complete-modal" id="completeModal">
    <div class="complete-modal-content">
      <div class="complete-modal-icon">üéØ</div>
      <h3>Complete Ride?</h3>
      <p>Confirm payment received and complete the ride</p>

      <div class="fare-display">
        <div class="fare-label">Total Fare Amount</div>
        <div class="fare-amount" id="completeFareAmount">‚Çπ--</div>
      </div>

      <div style="margin: 1rem 0;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Payment Method:</label>
        <select id="paymentMethodSelect"
          style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--card-bg); color: var(--text); font-size: 1rem;">
          <option value="cash">üíµ Cash</option>
          <option value="upi">üì± UPI / PhonePe / GPay</option>
          <option value="card">üí≥ Card (Coming Soon)</option>
        </select>
      </div>

      <div class="payment-reminder"
        style="background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; padding: 0.75rem; border-radius: 4px; margin: 1rem 0;">
        ‚úÖ Confirm you received payment from rider
      </div>

      <div style="font-size: 0.85rem; color: var(--text-muted); margin: 0.5rem 0;">
        Your earnings: <strong id="driverEarnings">‚Çπ--</strong> (after 10% platform fee)
      </div>

      <div class="complete-modal-buttons">
        <button class="btn-cancel-complete" onclick="closeCompleteModal()">
          Cancel
        </button>
        <button class="btn-confirm-complete" onclick="confirmCompleteRide()">
          ‚úÖ Payment Received - Complete
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Message -->
  <div class="toast-message" id="toastMessage">
    <div class="toast-icon" id="toastIcon">‚ÑπÔ∏è</div>
    <div class="toast-content">
      <div class="toast-title" id="toastTitle">Information</div>
      <div class="toast-text" id="toastText">Message</div>
    </div>
    <div class="toast-close" onclick="hideToast()">√ó</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    let map;
    let driverMarker;
    let targetMarker;
    let routeLine;
    let socket;
    let currentRide = null;
    let rideStatus = 'accepted'; // accepted, arrived, started
    let watchId = null;
    const API_BASE = API_CONFIG.BASE_URL;

    // Get ride ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const rideId = urlParams.get('rideId');

    if (!rideId) {
      showToast('Error', 'No ride ID provided', 'error');
      setTimeout(() => window.location.href = 'driver_home.html', 2000);
    }

    // Initialize
    window.addEventListener('load', async () => {
      // Check Firebase auth
      firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = '../common/signin.html';
          return;
        }

        await loadRideDetails();
        initMap();
        startLocationTracking();
        initSocket();
      });
    });

    async function loadRideDetails() {
      try {
        // First try to get ride data from sessionStorage (passed from accept)
        const storedRideData = sessionStorage.getItem('acceptedRide');
        if (storedRideData) {
          currentRide = JSON.parse(storedRideData);
          console.log('Loaded ride from session:', currentRide);
          sessionStorage.removeItem('acceptedRide');
          displayRideDetails();
          return;
        }

        // Otherwise fetch from API
        const response = await apiFetch(`/rides/${rideId}`);

        if (!response.ok) {
          throw new Error('Failed to load ride details');
        }

        currentRide = response.data;
        console.log('Ride details:', currentRide);

        displayRideDetails();

      } catch (error) {
        console.error('Error loading ride:', error);
        showToast('Error', 'Failed to load ride details', 'error');
      }
    }

    function displayRideDetails() {
      if (!currentRide) return;

      // Update rider info
      document.getElementById('riderAvatar').textContent = (currentRide.riderName || 'R').charAt(0).toUpperCase();
      document.getElementById('riderName').textContent = currentRide.riderName || 'Rider';

      // Update ride details
      document.getElementById('fareAmount').textContent = '‚Çπ' + (currentRide.fare || '--');
      document.getElementById('distanceValue').textContent = currentRide.distance ? (currentRide.distance).toFixed(1) + ' km' : '-- km';
      document.getElementById('durationValue').textContent = currentRide.duration ? currentRide.duration + ' min' : '-- min';

      // Update locations
      document.getElementById('locationAddress').textContent = currentRide.pickup?.address || 'Loading...';
      document.getElementById('dropAddress').textContent = currentRide.destination?.address || currentRide.dropoff?.address || 'Loading...';

      // Update status based on ride status
      updateUIForStatus(currentRide.status);
    }

    function updateUIForStatus(status) {
      rideStatus = status;
      const heading = document.getElementById('statusHeading');
      const subtext = document.getElementById('statusSubtext');
      const btnReached = document.getElementById('btnReached');
      const locationLabel = document.getElementById('locationLabel');
      const dropLocationItem = document.getElementById('dropLocationItem');

      if (status === 'accepted') {
        heading.textContent = 'üöó Navigate to Pickup';
        subtext.textContent = 'Head to the pickup location to meet your rider';
        btnReached.textContent = '‚úÖ Reached Pickup Point';
        btnReached.onclick = markArrived;
        locationLabel.textContent = 'Pickup Location';
        dropLocationItem.style.display = 'none';
      } else if (status === 'arrived') {
        heading.textContent = 'üëã Waiting for Rider';
        subtext.textContent = 'You have reached the pickup point';
        btnReached.textContent = 'üîê Enter OTP & Start Ride';
        btnReached.onclick = showOTPModal;
        locationLabel.textContent = 'Pickup Location';
        dropLocationItem.style.display = 'none';
      } else if (status === 'started') {
        heading.textContent = 'üöÄ Ride in Progress';
        subtext.textContent = 'Navigate to the drop location';
        btnReached.textContent = 'üéØ Reached Destination';
        btnReached.onclick = showCompleteModal;
        locationLabel.textContent = 'Current Location';
        dropLocationItem.style.display = 'flex';
      }
    }

    function initMap() {
      if (!currentRide) return;

      // Initialize Leaflet map centered on pickup (or driver location)
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          map = L.map('map').setView([lat, lng], 14);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
          }).addTo(map);

          // Add driver marker
          const driverIcon = L.divIcon({
            html: '<div style="font-size: 2rem;">üöó</div>',
            className: 'custom-marker',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
          });
          driverMarker = L.marker([lat, lng], { icon: driverIcon })
            .addTo(map)
            .bindPopup('Your Location');

          // Add target marker based on status
          updateTargetMarker();
        },
        (error) => {
          console.error('Location error:', error);
          // Fallback to pickup location
          map = L.map('map').setView([currentRide.pickup.lat, currentRide.pickup.lng], 14);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
          }).addTo(map);
          updateTargetMarker();
        }
      );
    }

    async function updateTargetMarker() {
      if (!map || !currentRide) return;

      // Remove existing target marker
      if (targetMarker) {
        map.removeLayer(targetMarker);
      }
      if (routeLine) {
        map.removeLayer(routeLine);
      }

      let targetLat, targetLng, targetLabel, targetEmoji;

      if (rideStatus === 'accepted' || rideStatus === 'arrived') {
        // Show pickup location
        targetLat = currentRide.pickup.lat;
        targetLng = currentRide.pickup.lng;
        targetLabel = 'Pickup Location';
        targetEmoji = 'üìç';
      } else if (rideStatus === 'started') {
        // Show drop location
        targetLat = currentRide.destination?.lat || currentRide.dropoff?.lat;
        targetLng = currentRide.destination?.lng || currentRide.dropoff?.lng;
        targetLabel = 'Drop Location';
        targetEmoji = 'üéØ';
      }

      // Add target marker
      const targetIcon = L.divIcon({
        html: `<div style="font-size: 2rem;">${targetEmoji}</div>`,
        className: 'custom-marker',
        iconSize: [40, 40],
        iconAnchor: [20, 40]
      });
      targetMarker = L.marker([targetLat, targetLng], { icon: targetIcon })
        .addTo(map)
        .bindPopup(targetLabel);

      // Draw route line if driver marker exists
      if (driverMarker) {
        const driverPos = driverMarker.getLatLng();
        await fetchRouteAndDraw(driverPos, { lat: targetLat, lng: targetLng });

        // Fit bounds
        const bounds = L.latLngBounds([
          [driverPos.lat, driverPos.lng],
          [targetLat, targetLng]
        ]);
        map.fitBounds(bounds, { padding: [50, 50] });
      }
    }

    async function fetchRouteAndDraw(fromPos, toPos) {
      try {
        const response = await fetch(
          `https://router.project-osrm.org/route/v1/driving/${fromPos.lng},${fromPos.lat};${toPos.lng},${toPos.lat}?overview=full&geometries=geojson`
        );
        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          if (routeLine) map.removeLayer(routeLine);
          routeLine = L.geoJSON(route.geometry, {
            style: {
              color: '#8b5cf6',
              weight: 4,
              opacity: 0.7
            }
          }).addTo(map);
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è OSRM routing failed, using straight line:', error);
        // Fallback to straight line
        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(
          [[fromPos.lat, fromPos.lng], [toPos.lat, toPos.lng]],
          { color: '#8b5cf6', weight: 4, opacity: 0.7 }
        ).addTo(map);
      }
    }

    function openGoogleMapsNavigation() {
      if (!currentRide) return;

      let targetLat, targetLng;
      if (rideStatus === 'accepted') {
        targetLat = currentRide.pickup.lat;
        targetLng = currentRide.pickup.lng;
      } else if (rideStatus === 'started') {
        targetLat = currentRide.dropoff.lat;
        targetLng = currentRide.dropoff.lng;
      } else {
        return;
      }

      // Open Google Maps with navigation
      const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${targetLat},${targetLng}&travelmode=driving`;
      window.open(mapsUrl, '_blank');
    }

    async function fetchRouteAndDraw(fromPos, toPos) {
      try {
        const response = await fetch(
          `https://router.project-osrm.org/route/v1/driving/${fromPos.lng},${fromPos.lat};${toPos.lng},${toPos.lat}?overview=full&geometries=geojson`
        );
        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          if (routeLine) map.removeLayer(routeLine);
          routeLine = L.geoJSON(route.geometry, {
            style: {
              color: '#8b5cf6',
              weight: 4,
              opacity: 0.7
            }
          }).addTo(map);
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è OSRM routing failed, using straight line:', error);
        // Fallback to straight line
        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(
          [[fromPos.lat, fromPos.lng], [toPos.lat, toPos.lng]],
          { color: '#8b5cf6', weight: 4, opacity: 0.7 }
        ).addTo(map);
      }
    }

    function openGoogleMapsNavigation() {
      if (!currentRide) return;

      let targetLat, targetLng, destination;
      if (rideStatus === 'accepted') {
        targetLat = currentRide.pickup.lat;
        targetLng = currentRide.pickup.lng;
        destination = 'Pickup Location';
      } else if (rideStatus === 'started') {
        targetLat = currentRide.dropoff.lat;
        targetLng = currentRide.dropoff.lng;
        destination = 'Drop Location';
      } else {
        showToast('Navigation not available at this stage');
        return;
      }

      // Open Google Maps with navigation
      const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${targetLat},${targetLng}&travelmode=driving`;
      window.open(mapsUrl, '_blank');
      showToast(`üó∫Ô∏è Opening Google Maps to ${destination}`);
    }

    function startLocationTracking() {
      if ('geolocation' in navigator) {
        watchId = navigator.geolocation.watchPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // Update driver marker on map
            if (driverMarker) {
              driverMarker.setLatLng([lat, lng]);

              // Redraw route line
              if (targetMarker) {
                const targetPos = targetMarker.getLatLng();
                fetchRouteAndDraw({ lat, lng }, { lat: targetPos.lat, lng: targetPos.lng });
              }
            }

            // Send location to server via Socket.IO
            if (socket && currentRide) {
              socket.emit('driver:location-update', {
                rideId: currentRide._id,
                location: { lat, lng }
              });
            }
          },
          (error) => {
            console.error('Location tracking error:', error);
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          }
        );
      }
    }

    function initSocket() {
      socket = io(API_CONFIG.WS_URL);

      socket.on('connect', () => {
        console.log('‚úÖ Socket connected');
        if (currentRide) {
          socket.emit('join-ride', currentRide._id);
        }
      });

      socket.on('ride:cancelled', (data) => {
        if (currentRide && data.rideId === currentRide._id) {
          showToast('Ride Cancelled', 'Rider has cancelled this ride', 'error');
          setTimeout(() => {
            window.location.href = 'driver_home.html';
          }, 2000);
        }
      });
    }

    async function markArrived() {
      try {
        const response = await apiFetch(`/rides/${rideId}/arrived`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(response.data?.message || 'Failed to mark arrival');
        }

        showToast('Arrival Marked', 'You have reached the pickup point', 'success');
        updateUIForStatus('arrived');

        // Show OTP modal after a short delay
        setTimeout(() => {
          showOTPModal();
        }, 1500);

      } catch (error) {
        console.error('Error marking arrival:', error);
        showToast('Error', error.message, 'error');
      }
    }

    function showOTPModal() {
      document.getElementById('otpModal').classList.add('show');
      document.getElementById('otp1').focus();

      // Setup OTP input auto-focus
      const inputs = document.querySelectorAll('.otp-input');
      inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          if (e.target.value && index < inputs.length - 1) {
            inputs[index + 1].focus();
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            inputs[index - 1].focus();
          }
        });
      });
    }

    function closeOTPModal() {
      document.getElementById('otpModal').classList.remove('show');
      // Clear OTP inputs
      document.querySelectorAll('.otp-input').forEach(input => input.value = '');
    }

    async function verifyOTP() {
      const otp1 = document.getElementById('otp1').value;
      const otp2 = document.getElementById('otp2').value;
      const otp3 = document.getElementById('otp3').value;
      const otp4 = document.getElementById('otp4').value;
      const otp = otp1 + otp2 + otp3 + otp4;

      if (otp.length !== 4) {
        showToast('Invalid OTP', 'Please enter all 4 digits', 'warning');
        return;
      }

      try {
        const response = await apiFetch(`/rides/${rideId}/start`, {
          method: 'POST',
          body: { otp }  // Pass object, not stringified JSON
        });

        if (!response.ok) {
          throw new Error(response.data?.message || 'Invalid OTP');
        }

        closeOTPModal();
        showToast('Ride Started', 'OTP verified successfully!', 'success');
        updateUIForStatus('started');
        updateTargetMarker();

      } catch (error) {
        console.error('Error verifying OTP:', error);
        showToast('Verification Failed', error.message, 'error');
      }
    }

    function callRider() {
      if (currentRide && currentRide.riderPhone) {
        window.location.href = `tel:${currentRide.riderPhone}`;
      } else {
        showToast('Phone Unavailable', 'Rider phone number is not available', 'warning');
      }
    }

    function cancelRide() {
      if (confirm('Are you sure you want to cancel this ride?')) {
        // TODO: Implement cancel ride API call
        showToast('Cancel Ride', 'Cancellation feature coming soon', 'warning');
      }
    }

    function showCompleteModal() {
      const modal = document.getElementById('completeModal');
      const fareAmount = document.getElementById('completeFareAmount');
      const driverEarnings = document.getElementById('driverEarnings');

      // Set fare amount in modal
      if (currentRide && currentRide.fare) {
        const totalFare = currentRide.fare;
        const platformFee = Math.round(totalFare * 0.10);
        const earnings = totalFare - platformFee;

        fareAmount.textContent = '‚Çπ' + totalFare;
        driverEarnings.textContent = '‚Çπ' + earnings;
      }

      modal.classList.add('show');
    }

    function closeCompleteModal() {
      const modal = document.getElementById('completeModal');
      modal.classList.remove('show');
    }

    async function confirmCompleteRide() {
      const user = firebase.auth().currentUser;
      if (!user) {
        showToast('Error', 'Please login again', 'error');
        closeCompleteModal();
        return;
      }

      // Get selected payment method
      const paymentMethod = document.getElementById('paymentMethodSelect').value;

      try {
        const response = await apiFetch(`/rides/${rideId}/complete`, {
          method: 'POST',
          body: {
            paymentMethod: paymentMethod,
            paymentConfirmed: true
          }
        });

        if (!response.ok) {
          const errorMessage = response.data?.message || 'Failed to complete ride';
          showToast('Error', errorMessage, 'error');
          closeCompleteModal();
          return;
        }

        closeCompleteModal();
        showToast('Success', 'Ride completed successfully!', 'success');

        // Stop location tracking
        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
        }

        // Redirect to home after 2 seconds
        setTimeout(() => {
          window.location.href = 'driver_home.html';
        }, 2000);
      } catch (error) {
        console.error('Error completing ride:', error);
        showToast('Error', 'Network error. Please try again.', 'error');
        closeCompleteModal();
      }
    }

    function goBack() {
      if (confirm('Are you sure you want to go back? The ride is still active.')) {
        window.location.href = 'driver_home.html';
      }
    }

    // Toast notification functions
    function showToast(title, message, type = 'info') {
      const toast = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      const toastTitle = document.getElementById('toastTitle');
      const toastText = document.getElementById('toastText');

      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è',
        warning: '‚ö†Ô∏è'
      };

      toastIcon.textContent = icons[type] || icons.info;
      toastTitle.textContent = title;
      toastText.textContent = message;

      toast.classList.remove('success', 'error', 'info', 'warning');
      toast.classList.add(type);
      toast.classList.add('show');

      setTimeout(() => {
        hideToast();
      }, 4000);
    }

    function hideToast() {
      document.getElementById('toastMessage').classList.remove('show');
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
      }
      if (socket) {
        socket.disconnect();
      }
    });
  </script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="../common/js/firebase-config.js"></script>
  <script src="../common/js/auth.js"></script>
</body>

</html>